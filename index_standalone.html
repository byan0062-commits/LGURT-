<!DOCTYPE html>
<html lang="zh-CN" class="theme-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGURT Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
/* ==================== ä»»åŠ¡0: Design Tokens (Apple-likeæç®€å•†åŠ¡é£) ==================== */
:root {
    /* Typography */
    --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    --font-mono: 'SF Mono', 'Menlo', monospace;
    
    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;
    
    /* Border radius */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    --shadow-xl: 0 25px 50px -12px rgba(0,0,0,0.25);
    
    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-base: 200ms ease;
    --transition-slow: 300ms ease;
}

/* Dark Theme (Default) */
.theme-dark {
    --bg-app: #0a0a0f;
    --bg-surface: #141418;
    --bg-elevated: #1c1c22;
    --bg-hover: #252530;
    --bg-active: #2d2d3a;
    
    --border-subtle: rgba(255,255,255,0.06);
    --border-default: rgba(255,255,255,0.1);
    --border-strong: rgba(255,255,255,0.15);
    
    --text-primary: #f5f5f7;
    --text-secondary: #a1a1a6;
    --text-tertiary: #6e6e73;
    --text-inverse: #1d1d1f;
    
    --accent-primary: #0071e3;
    --accent-success: #30d158;
    --accent-warning: #ff9f0a;
    --accent-danger: #ff453a;
    --accent-info: #64d2ff;
    
    --kpi-positive: #30d158;
    --kpi-negative: #ff453a;
    --kpi-neutral: #a1a1a6;
}

/* Light Theme (Optional) */
.theme-light {
    --bg-app: #f5f5f7;
    --bg-surface: #ffffff;
    --bg-elevated: #ffffff;
    --bg-hover: #f5f5f7;
    --bg-active: #e8e8ed;
    
    --border-subtle: rgba(0,0,0,0.04);
    --border-default: rgba(0,0,0,0.08);
    --border-strong: rgba(0,0,0,0.12);
    
    --text-primary: #1d1d1f;
    --text-secondary: #6e6e73;
    --text-tertiary: #a1a1a6;
    --text-inverse: #f5f5f7;
    
    --accent-primary: #0071e3;
    --accent-success: #34c759;
    --accent-warning: #ff9500;
    --accent-danger: #ff3b30;
    --accent-info: #5ac8fa;
    
    --kpi-positive: #34c759;
    --kpi-negative: #ff3b30;
    --kpi-neutral: #6e6e73;
}

/* ==================== Base Styles ==================== */
* { box-sizing: border-box; }
body { 
    font-family: var(--font-sans);
    background: var(--bg-app);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
}

/* ==================== Semantic Classes ==================== */
.app-bg { background: var(--bg-app); }
.surface { background: var(--bg-surface); }
.elevated { background: var(--bg-elevated); }

.panel {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
}
.panel:hover { border-color: var(--border-default); }
.panel-header { padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--border-subtle); }
.panel-body { padding: var(--space-lg); }

.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-tertiary { color: var(--text-tertiary); }

/* KPI Cards */
.kpi-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
}
.kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.kpi-label { font-size: 12px; font-weight: 500; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.kpi-value { font-size: 28px; font-weight: 600; line-height: 1.1; letter-spacing: -0.5px; }
.kpi-value.positive { color: var(--kpi-positive); }
.kpi-value.negative { color: var(--kpi-negative); }
.kpi-sub { font-size: 13px; color: var(--text-secondary); margin-top: 6px; }

/* Buttons */
.btn { 
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px 18px; font-size: 14px; font-weight: 500;
    border-radius: var(--radius-md); border: none; cursor: pointer;
    transition: all var(--transition-fast);
}
.btn-primary { background: var(--accent-primary); color: white; }
.btn-primary:hover { filter: brightness(1.1); transform: scale(1.02); }
.btn-secondary { background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-default); }
.btn-secondary:hover { background: var(--bg-active); }

/* Badges */
.badge { 
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; font-size: 12px; font-weight: 500;
    border-radius: 100px; 
}
.badge-success { background: rgba(48,209,88,0.15); color: var(--accent-success); }
.badge-warning { background: rgba(255,159,10,0.15); color: var(--accent-warning); }
.badge-danger { background: rgba(255,69,58,0.15); color: var(--accent-danger); }
.badge-info { background: rgba(100,210,255,0.15); color: var(--accent-info); }
.badge-neutral { background: var(--bg-hover); color: var(--text-secondary); }

/* Chips */
.chip { 
    padding: 6px 14px; font-size: 13px; font-weight: 500;
    border-radius: 100px; cursor: pointer;
    background: var(--bg-hover); color: var(--text-secondary);
    border: 1px solid transparent;
    transition: all var(--transition-fast);
}
.chip:hover { background: var(--bg-active); color: var(--text-primary); }
.chip.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

/* Tables */
.data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.data-table th { 
    padding: 12px 16px; text-align: left;
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-tertiary); background: var(--bg-elevated);
    border-bottom: 1px solid var(--border-default);
}
.data-table td { 
    padding: 14px 16px; font-size: 14px;
    border-bottom: 1px solid var(--border-subtle);
    transition: background var(--transition-fast);
}
.data-table tbody tr:hover td { background: var(--bg-hover); }
.data-table .text-right { text-align: right; }
.data-table .sortable { cursor: pointer; user-select: none; }
.data-table .sortable:hover { color: var(--accent-primary); }

/* Alerts */
.alert {
    display: flex; align-items: flex-start; gap: 12px;
    padding: var(--space-md); border-radius: var(--radius-md);
    border: 1px solid;
}
.alert-critical { background: rgba(255,69,58,0.08); border-color: rgba(255,69,58,0.2); }
.alert-warning { background: rgba(255,159,10,0.08); border-color: rgba(255,159,10,0.2); }
.alert-success { background: rgba(48,209,88,0.08); border-color: rgba(48,209,88,0.2); }
.alert-info { background: rgba(100,210,255,0.08); border-color: rgba(100,210,255,0.2); }

/* Inputs */
.input {
    padding: 10px 14px; font-size: 14px;
    background: var(--bg-elevated); color: var(--text-primary);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    transition: all var(--transition-fast);
}
.input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(0,113,227,0.2); }
.input::placeholder { color: var(--text-tertiary); }

/* Tabs */
.tab-nav { display: flex; gap: 4px; padding: 4px; background: var(--bg-elevated); border-radius: var(--radius-md); }
.tab-btn { 
    padding: 10px 18px; font-size: 14px; font-weight: 500;
    color: var(--text-secondary); background: transparent;
    border: none; border-radius: var(--radius-sm); cursor: pointer;
    transition: all var(--transition-fast);
}
.tab-btn:hover { color: var(--text-primary); background: var(--bg-hover); }
.tab-btn.active { color: var(--text-primary); background: var(--bg-surface); box-shadow: var(--shadow-sm); }

/* Modals */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; }
.modal-content { 
    background: var(--bg-surface); 
    border-radius: var(--radius-xl); 
    box-shadow: var(--shadow-xl);
    max-height: 90vh; overflow: hidden;
}
.modal-header { 
    padding: var(--space-lg); 
    border-bottom: 1px solid var(--border-subtle);
    display: flex; justify-content: space-between; align-items: center;
}
.modal-title { font-size: 18px; font-weight: 600; }
.modal-close { 
    width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    background: var(--bg-hover); border-radius: 50%; cursor: pointer;
    color: var(--text-secondary); font-size: 18px;
    transition: all var(--transition-fast);
}
.modal-close:hover { background: var(--bg-active); color: var(--text-primary); }
.modal-body { padding: var(--space-lg); overflow-y: auto; max-height: calc(90vh - 140px); }

/* Header */
.app-header {
    position: sticky; top: 0; z-index: 50;
    background: var(--bg-surface); 
    border-bottom: 1px solid var(--border-subtle);
    backdrop-filter: blur(20px);
}

/* Dropdown */
.dropdown { position: relative; }
.dropdown-trigger { cursor: pointer; }
.dropdown-menu { 
    position: absolute; right: 0; top: 100%; margin-top: 4px;
    min-width: 180px; padding: 6px;
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
    opacity: 0; visibility: hidden; transform: translateY(-8px);
    transition: all var(--transition-fast);
}
.dropdown:hover .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
.dropdown-item {
    display: block; padding: 10px 14px; font-size: 14px;
    color: var(--text-primary); border-radius: var(--radius-sm);
    cursor: pointer; transition: background var(--transition-fast);
}
.dropdown-item:hover { background: var(--bg-hover); }

/* Upload Zone */
.upload-zone {
    border: 2px dashed var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-2xl);
    text-align: center;
    transition: all var(--transition-base);
    cursor: pointer;
}
.upload-zone:hover, .upload-zone.dragover { 
    border-color: var(--accent-primary); 
    background: rgba(0,113,227,0.05); 
}

/* Theme Toggle */
.theme-toggle {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-hover); border-radius: 50%;
    cursor: pointer; font-size: 16px;
    transition: all var(--transition-fast);
}
.theme-toggle:hover { background: var(--bg-active); }

/* Quadrant Grid */
.quadrant-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; }
.quadrant-cell { padding: var(--space-md); background: var(--bg-surface); }

/* Progress bars */
.progress { height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 3px; transition: width var(--transition-slow); }

/* PDF Print Styles */
@media print {
    body { background: white !important; color: #1d1d1f !important; }
    .panel, .kpi-card { border: 1px solid #e5e5e5 !important; background: white !important; }
    .no-print { display: none !important; }
}

/* Animation */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Upload Section -->
        <div id="upload-section" class="max-w-xl mx-auto px-6 py-20">
            <header class="text-center mb-10">
                <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-3xl">ğŸ“Š</div>
                <h1 class="text-3xl font-semibold text-primary mb-2">LGURT Dashboard</h1>
                <p class="text-secondary">ä¸Šä¼ Excelï¼Œè‡ªåŠ¨ç”Ÿæˆç»è¥åˆ†ææŠ¥å‘Š <span class="badge badge-neutral">v5.1</span></p>
            </header>
            <div class="panel">
                <div class="panel-body">
                    <div id="upload-zone" class="upload-zone mb-6">
                        <div class="text-5xl mb-4 opacity-60">ğŸ“„</div>
                        <p class="text-lg text-primary mb-2">æ‹–æ”¾ Excel æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                        <p class="text-secondary text-sm mb-4">æ”¯æŒ .xlsx æ ¼å¼</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls" class="hidden">
                        <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                    <div class="flex items-center justify-center gap-6 flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-secondary text-sm">æ•°æ®å‘¨æœŸ</label>
                            <input type="number" id="days-input" value="31" min="1" max="365" class="input w-20 text-center">
                            <span class="text-secondary text-sm">å¤©</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-secondary text-sm">å¤´ç¨‹æ¨¡å¼</label>
                            <select id="lead-time-select" class="input">
                                <option value="15">å¿«èˆ¹ (15å¤©)</option>
                                <option value="35" selected>æ…¢èˆ¹ (35å¤©)</option>
                                <option value="45">ææ…¢èˆ¹ (45å¤©)</option>
                            </select>
                        </div>
                    </div>
                    <div id="upload-status" class="mt-4 text-center hidden"><span class="text-secondary">â³ å¤„ç†ä¸­...</span></div>
                    <div id="upload-error" class="mt-4 text-center hidden" style="color: var(--accent-danger);"></div>
                </div>
            </div>
            <div id="history-section" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-secondary text-sm font-medium">ğŸ“‹ å†å²è®°å½•</span>
                    <button onclick="clearAllHistory()" class="text-xs" style="color: var(--accent-danger);">æ¸…é™¤å…¨éƒ¨</button>
                </div>
                <div id="history-list" class="space-y-2 max-h-64 overflow-auto"></div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="hidden">
            <header class="app-header">
                <div class="max-w-7xl mx-auto px-6 py-4">
                    <div class="flex justify-between items-center flex-wrap gap-3">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-xl">ğŸ“Š</div>
                            <div>
                                <h1 class="text-lg font-semibold text-primary">LGURT Dashboard</h1>
                                <p id="period-label" class="text-xs text-tertiary"></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="text" id="sku-search" placeholder="æœç´¢ SKU / ASIN..." class="input w-44">
                            <div id="filter-badge" class="hidden"></div>
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-trigger">ğŸ“¥ å¯¼å‡º â–¾</button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" onclick="exportPDF()">ğŸ“„ PDF æŠ¥å‘Š</a>
                                    <a class="dropdown-item" onclick="exportXLSX()">ğŸ“Š Excel å®Œæ•´æŠ¥å‘Š</a>
                                    <a class="dropdown-item" onclick="exportCSV()">ğŸ“‹ CSV</a>
                                </div>
                            </div>
                            <div class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</div>
                            <button onclick="resetDashboard()" class="btn btn-secondary">é‡æ–°ä¸Šä¼ </button>
                        </div>
                    </div>
                    <nav class="tab-nav mt-4 no-print">
                        <button onclick="switchTab('overview')" class="tab-btn active" data-tab="overview">ğŸ“Š æ¦‚è§ˆ</button>
                        <button onclick="switchTab('decision')" class="tab-btn" data-tab="decision">ğŸ§  å†³ç­–</button>
                        <button onclick="switchTab('profit')" class="tab-btn" data-tab="profit">ğŸ’° åˆ©æ¶¦</button>
                        <button onclick="switchTab('ads')" class="tab-btn" data-tab="ads">ğŸ¯ å¹¿å‘Š</button>
                        <button onclick="switchTab('inventory')" class="tab-btn" data-tab="inventory">ğŸ“¦ åº“å­˜</button>
                        <button onclick="switchTab('config')" class="tab-btn" data-tab="config">âš™ï¸ é…ç½®</button>
                    </nav>
                </div>
            </header>
            
            <main class="max-w-7xl mx-auto px-6 py-8">
                <div id="alert-banner" class="mb-6"></div>
                <div id="redline-alerts" class="space-y-3 mb-6"></div>
                <div id="tab-overview" class="tab-content space-y-6 animate-in"></div>
                <div id="tab-decision" class="tab-content hidden space-y-6"></div>
                <div id="tab-profit" class="tab-content hidden space-y-6"></div>
                <div id="tab-ads" class="tab-content hidden space-y-6"></div>
                <div id="tab-inventory" class="tab-content hidden space-y-6"></div>
                <div id="tab-config" class="tab-content hidden"></div>
            </main>
            
            <footer class="border-t py-6 mt-8 no-print" style="border-color: var(--border-subtle);">
                <div class="max-w-7xl mx-auto px-6 text-center text-sm text-tertiary">
                    LGURT Business Dashboard v5.2 Â· æç®€å•†åŠ¡ç‰ˆ
                </div>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="history-modal" class="modal-backdrop hidden flex items-center justify-center p-4">
        <div class="modal-content max-w-2xl w-full">
            <div class="modal-header"><span class="modal-title" id="modal-title">å†å²è¯¦æƒ…</span><span class="modal-close" onclick="closeHistoryModal()">Ã—</span></div>
            <div class="modal-body" id="modal-content"></div>
            <div class="p-4 border-t flex gap-3 justify-end" style="border-color: var(--border-subtle);">
                <button onclick="loadHistoryData(currentHistoryIndex)" class="btn btn-primary">åŠ è½½åˆ°çœ‹æ¿</button>
                <button onclick="closeHistoryModal()" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="sku-detail-modal" class="modal-backdrop hidden flex items-center justify-center p-4">
        <div class="modal-content max-w-2xl w-full">
            <div class="modal-header"><span class="modal-title" id="sku-modal-title">SKU è¯Šæ–­</span><span class="modal-close" onclick="closeSkuModal()">Ã—</span></div>
            <div class="modal-body" id="sku-modal-content"></div>
        </div>
    </div>

    <div id="pdf-tip-modal" class="modal-backdrop hidden flex items-center justify-center p-4">
        <div class="modal-content max-w-md w-full p-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ“„ PDF å¯¼å‡º</h3>
            <p class="text-secondary mb-6">è¯·åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹©ã€Œå¦å­˜ä¸ºPDFã€ï¼Œå»ºè®®å–æ¶ˆé¡µçœ‰é¡µè„šä»¥è·å¾—æ›´å¥½æ•ˆæœã€‚</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closePdfTipAndPrint()" class="btn btn-primary">å¼€å§‹å¯¼å‡º</button>
                <button onclick="document.getElementById('pdf-tip-modal').classList.add('hidden')" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <iframe id="print-frame" style="position:absolute;width:0;height:0;border:none;"></iframe>

<script>
// ==================== å…¨å±€å˜é‡ ====================
let D = null, allSkus = [], charts = {}, categories = [], currentHistoryIndex = -1;
let skuRoles = {}, runId = '';
let overviewSort = { field: 'op', asc: false };
let overviewFilter = 'all';
const HISTORY_KEY = 'lgurt_calc_history_v5';
const SKU_ROLES_KEY = 'lgurt_sku_roles';
const THEME_KEY = 'lgurt_theme';
const ALGO_VERSION = 'v5.2';

// ==================== åº“å­˜é…ç½® ====================
const INV_CONFIG = {
    leadTimeDays: 35,
    safetyDays: 30,
    targetCoverDays: 90,
    lowStockThreshold: 7,
    overStockThreshold: 120,
    minOrderQty: 1,
    packRound: 1
};

// ==================== SKUè§’è‰²é…ç½® ====================
const SKU_ROLE_CONFIG = {
    profit: { name: 'ç›ˆåˆ©æ¬¾', color: 'success', allowedLoss: 0, stopLoss: 0, windowWeeks: null, desc: 'ä¸å…è®¸äºæŸï¼ŒäºæŸå¿…é¡»ä¿®å¤æˆ–æ­¢æŸ' },
    traffic: { name: 'å¼•æµæ¬¾', color: 'info', allowedLoss: -0.10, stopLoss: -0.15, windowWeeks: 8, desc: 'å…è®¸å°å¹…äºæŸ(-10%)ï¼Œéœ€è¯æ˜æµé‡ä»·å€¼' },
    defense: { name: 'é˜²å¾¡æ¬¾', color: 'warning', allowedLoss: -0.15, stopLoss: -0.25, windowWeeks: 4, desc: 'å…è®¸æ›´å¤§äºæŸ(-15%)ï¼Œæ‰¿æ‹…é˜²å¾¡ä»»åŠ¡' },
    test: { name: 'æµ‹è¯•æ¬¾', color: 'neutral', allowedLoss: -0.30, stopLoss: -0.50, windowWeeks: 8, desc: 'æ–°å“æµ‹è¯•æœŸï¼Œå…è®¸æœ€å¤§äºæŸ(-30%)' }
};

// ==================== ç­›é€‰çŠ¶æ€ ====================
const FilterState = {
    querySku: '',
    get selectedSkus() {
        if (!D || !D.skus) return [];
        let result = D.skus;
        if (this.querySku) {
            const q = this.querySku.toLowerCase();
            result = result.filter(s => s.sku.toLowerCase().includes(q) || s.name.toLowerCase().includes(q) || s.asin.toLowerCase().includes(q));
        }
        return result;
    }
};

// ==================== Theme Toggle ====================
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.contains('theme-dark');
    html.classList.toggle('theme-dark', !isDark);
    html.classList.toggle('theme-light', isDark);
    localStorage.setItem(THEME_KEY, isDark ? 'light' : 'dark');
    document.querySelector('.theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
}
(function initTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved === 'light') { document.documentElement.classList.replace('theme-dark', 'theme-light'); }
})();

// ==================== åº“å­˜è®¡ç®— ====================
function calcInventoryMetrics(sku, config = INV_CONFIG) {
    const ful = sku.ful || 0, inb = sku.inb || 0, rsv = sku.rsv || 0, du = sku.du || 0;
    if (du <= 0) return { sellableDOS: null, totalDOS: null, stockoutGap: null, status: 'no-sales', statusColor: 'neutral', overstockRisk: false, ropUnits: 0, targetUnits: 0, availableUnits: 0, orderQty: 0, hasReservedData: sku.rsv !== undefined };
    
    const sellableDOS = ful / du;
    const totalDOS = (ful + inb - rsv) / du;
    const stockoutGap = Math.max(0, config.leadTimeDays - sellableDOS);
    
    let status, statusColor;
    if (sellableDOS < config.lowStockThreshold) { status = 'critical'; statusColor = 'danger'; }
    else if (sellableDOS < config.leadTimeDays) { status = 'reorder-now'; statusColor = 'warning'; }
    else if (sellableDOS < 15) { status = 'watch'; statusColor = 'warning'; }
    else { status = 'healthy'; statusColor = 'success'; }
    
    const overstockRisk = totalDOS > config.overStockThreshold;
    const ropUnits = (config.leadTimeDays + config.safetyDays) * du;
    const targetUnits = config.targetCoverDays * du;
    const availableUnits = ful + inb - rsv;
    let orderQty = Math.max(0, targetUnits - availableUnits);
    if (orderQty > 0) orderQty = Math.max(config.minOrderQty, Math.ceil(orderQty / config.packRound) * config.packRound);
    
    return { sellableDOS: rd(sellableDOS, 1), totalDOS: rd(totalDOS, 1), stockoutGap: rd(stockoutGap, 1), status, statusColor, overstockRisk, ropUnits: rd(ropUnits, 0), targetUnits: rd(targetUnits, 0), availableUnits: rd(availableUnits, 0), orderQty: rd(orderQty, 0), hasReservedData: sku.rsv !== undefined };
}

function getInvStatusBadge(m) {
    const map = { 'critical': ['danger', 'ğŸ”´ æ–­è´§é£é™©'], 'reorder-now': ['warning', 'ğŸŸ  éœ€è¡¥è´§'], 'watch': ['warning', 'ğŸŸ¡ å…³æ³¨'], 'healthy': ['success', 'ğŸŸ¢ å¥åº·'], 'no-sales': ['neutral', 'âš« æ— é”€é‡'] };
    const [c, t] = map[m.status] || ['neutral', m.status];
    let html = `<span class="badge badge-${c}">${t}</span>`;
    if (m.overstockRisk) html += ` <span class="badge badge-info">ğŸ“¦ ç§¯å‹</span>`;
    return html;
}

function formatDOS(val) { return val === null ? '<span class="text-tertiary">â€”</span>' : val.toFixed(1) + 'å¤©'; }

// ==================== SKUå››è±¡é™ ====================
function classifySkuQuadrant(sku) {
    const adContrib = sku.adSales * sku.pm - sku.adSpend;
    if (sku.pm > 0 && adContrib >= 0) return 'star';
    if (sku.pm > 0 && adContrib < 0) return 'dog';
    if (sku.pm <= 0 && adContrib >= 0) return 'question';
    return 'eliminate';
}

function getQuadrantInfo(q) {
    return { star: { name: 'æ˜æ˜Ÿ', icon: 'ğŸŸ¢', color: 'success' }, question: { name: 'é—®é¢˜', icon: 'ğŸŸ¡', color: 'warning' }, dog: { name: 'ç˜¦ç‹—', icon: 'ğŸŸ ', color: 'warning' }, eliminate: { name: 'æ·˜æ±°', icon: 'ğŸ”´', color: 'danger' } }[q] || { name: 'æ·˜æ±°', icon: 'ğŸ”´', color: 'danger' };
}

// ==================== SKUè¯Šæ–­ ====================
function generateSkuDiagnosis(sku) {
    const role = getSkuRole(sku.sku);
    const rc = SKU_ROLE_CONFIG[role];
    const q = classifySkuQuadrant(sku);
    const qInfo = getQuadrantInfo(q);
    const adContrib = sku.adSales * sku.pm - sku.adSpend;
    const inv = calcInventoryMetrics(sku);
    
    let issues = [], actions = [], stopLoss = [];
    let isHealthy = true;
    
    if (inv.status === 'critical') { issues.push({ type: 'critical', text: `å¯å”®åº“å­˜ä»…${inv.sellableDOS?.toFixed(1)||0}å¤©ï¼Œä½äº${INV_CONFIG.lowStockThreshold}å¤©é˜ˆå€¼` }); actions.push({ priority: 0, text: 'ã€ç´§æ€¥ã€‘ç«‹å³è¡¥è´§æˆ–è°ƒæ‹¨', condition: 'åº“å­˜æ¢å¤å‰ä¸åšå…¶ä»–ä¼˜åŒ–' }); isHealthy = false; }
    else if (inv.status === 'reorder-now') { issues.push({ type: 'warning', text: `å¯å”®åº“å­˜${inv.sellableDOS?.toFixed(1)||0}å¤©ï¼Œç­‰ä¸åˆ°${INV_CONFIG.leadTimeDays}å¤©å¤´ç¨‹` }); actions.push({ priority: 1, text: 'ã€é‡è¦ã€‘åŠ æ€¥è¡¥è´§æˆ–è€ƒè™‘ç©ºè¿', condition: 'è¯„ä¼°æ–­è´§æˆæœ¬vsç©ºè¿æˆæœ¬' }); }
    
    if (sku.pm < 0) { issues.push({ type: 'critical', text: `å®šä»·æ¯›åˆ©ä¸ºè´Ÿ(${pct(sku.pm)})` }); isHealthy = false; if (role === 'profit') { actions.push({ priority: 1, text: 'ã€è¯Šæ–­ã€‘æ£€æŸ¥æˆæœ¬ç»“æ„ï¼šé‡‡è´­/å¤´ç¨‹/FBA', condition: 'å®šä½ä¸»è¦æˆæœ¬é—®é¢˜' }); stopLoss.push('è‹¥4å‘¨åå®šä»·æ¯›åˆ©ä»<0ï¼Œè¿›å…¥é€€å‡ºæµç¨‹'); } }
    
    if (sku.ar > sku.pm && sku.adSpend > 0) { issues.push({ type: 'critical', text: `å¹¿å‘Šå æ¯”(${pct(sku.ar)})è¶…è¿‡æ¯›åˆ©ç‡(${pct(sku.pm)})` }); isHealthy = false; actions.push({ priority: 1, text: 'ã€ç«‹å³ã€‘æ‰§è¡ŒPhase1ç æ— æ„ä¹‰æ¶ˆè€—', condition: 'å…ˆç ACOS>200%çš„è¯' }); }
    if (adContrib < 0 && sku.adSpend > 50) { issues.push({ type: 'warning', text: `å¹¿å‘Šè´¡çŒ®åˆ©æ¶¦ä¸ºè´Ÿ($${adContrib.toFixed(0)})` }); actions.push({ priority: 2, text: 'ã€ä¼˜åŒ–ã€‘å¦å®šACOS>50%è¯ï¼Œé™é•¿å°¾ç«ä»·20%', condition: '2å‘¨åå¤ç›˜æ•ˆæœ' }); }
    
    if (sku.om < rc.allowedLoss) { issues.push({ type: 'warning', text: `ç»è¥æ¯›åˆ©(${pct(sku.om)})ä½äº${rc.name}å®¹å¿çº¿(${pct(rc.allowedLoss)})` }); if (sku.om < rc.stopLoss) { issues.push({ type: 'critical', text: `è§¦å‘æ­¢æŸçº¿(${pct(rc.stopLoss)})` }); stopLoss.push(`${rc.name}æ­¢æŸçº¿å·²è§¦å‘ï¼Œå»ºè®®ï¼š${role === 'test' ? 'é™çº§ä¸ºprofitæ¬¾' : 'å¯åŠ¨é€€å‡ºæµç¨‹'}`); isHealthy = false; } }
    
    if (q === 'star' && inv.status !== 'critical' && sku.ar < sku.pm * 0.8 && (inv.sellableDOS || 0) > 30) actions.push({ priority: 3, text: 'ã€æ”¾é‡ã€‘å¹¿å‘Šå æ¯”ä½äºå®‰å…¨çº¿80%ï¼Œå¯å¢åŠ é¢„ç®—10%/å‘¨', condition: 'åº“å­˜>30å¤©ä¸”æ— æ–­è´§é£é™©' });
    else if (q === 'dog') { actions.push({ priority: 2, text: 'ã€å¹¿å‘Šä¼˜åŒ–ã€‘ACOSè¿‡é«˜ï¼Œæ‰§è¡ŒPhase1+Phase2', condition: 'ç›®æ ‡4å‘¨å†…å¹¿å‘Šè´¡çŒ®è½¬æ­£' }); if (role === 'traffic') actions.push({ priority: 3, text: 'ã€è¯„ä¼°å¼•æµä»·å€¼ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºå˜ä½“å…¥å£', condition: 'è‹¥æ•´ä½“åˆ©æ¶¦æ­£å¯ä¿ç•™' }); }
    else if (q === 'eliminate') { actions.push({ priority: 1, text: 'ã€å¯åŠ¨é€€å‡ºã€‘å®šä»·äº+å¹¿å‘Šäºï¼ŒåŒé‡é—®é¢˜', condition: 'é™¤éæœ‰æˆ˜ç•¥ä»·å€¼' }); if ((inv.totalDOS || 0) > 60) actions.push({ priority: 2, text: 'ã€æ¸…ä»“ã€‘åº“å­˜' + (inv.totalDOS?.toFixed(0) || '?') + 'å¤©ï¼Œç›®æ ‡8å‘¨æ¸…å®Œ', condition: 'å¯é™ä»·ä¿ƒé”€' }); stopLoss.push('ç«‹å³åœæ­¢è¡¥è´§'); }
    
    actions.sort((a, b) => a.priority - b.priority);
    return { sku: sku.sku, quadrant: q, qInfo, role, roleConfig: rc, issues, actions, stopLoss, isHealthy, inv, adContrib };
}

// ==================== ä»»åŠ¡1: å¹¿å‘ŠPhase1/Phase2ç»“æ„åŒ–è¾“å‡º ====================
function generateAdOptimizationPlan(s, skus) {
    const currentAdRatio = s.ar, pricingMargin = s.pm, dailyRev = s.dRev, dailyFixed = s.mfDaily;
    const breakEvenAdRatio = pricingMargin - (dailyRev > 0 ? dailyFixed / dailyRev : 0);
    const targetAdRatio = Math.max(0, breakEvenAdRatio * 0.9);
    const needReduce = currentAdRatio > targetAdRatio;
    const gap = Math.max(0, currentAdRatio - targetAdRatio);
    const adDependency = s.rev > 0 ? s.adSales / s.rev : 0;
    
    const adSkus = skus.filter(x => x.adSpend > 0);
    
    // ========== Phase 1: æ— æ„ä¹‰æ¶ˆè€—æ¸…å•ï¼ˆç»“æ„åŒ–æ•°ç»„ï¼‰ ==========
    let phase1WasteList = [];
    
    // 1) é«˜èŠ±è´¹é›¶å½’å› 
    adSkus.filter(x => x.adSpend > 30 && x.adSales === 0).forEach(x => {
        phase1WasteList.push({ sku: x.sku, asin: x.asin, wasted_spend: x.adSpend, reason: 'å¹¿å‘ŠèŠ±è´¹$' + x.adSpend.toFixed(0) + 'ä½†å½’å› é”€å”®ä¸º0', suggested_action: 'pause', action_desc: 'æš‚åœè¯¥SKUæ‰€æœ‰å¹¿å‘ŠæŠ•æ”¾' });
    });
    
    // 2) ACOSæé«˜ (>300%)
    adSkus.filter(x => x.acos > 3 && x.adSpend > 20).forEach(x => {
        if (!phase1WasteList.find(p => p.sku === x.sku)) {
            phase1WasteList.push({ sku: x.sku, asin: x.asin, wasted_spend: x.adSpend * 0.8, reason: 'ACOS=' + pct(x.acos) + 'æé«˜ï¼ŒæŠ•å…¥äº§å‡ºä¸¥é‡å¤±è¡¡', suggested_action: 'restructure', action_desc: 'ç æ‰80%é¢„ç®—ï¼Œä»…ä¿ç•™æ ¸å¿ƒè¯' });
        }
    });
    
    // 3) å¹¿å‘Šå æ¯”>æ¯›åˆ©ç‡Ã—2
    adSkus.filter(x => x.ar > x.pm * 2 && x.adSpend > 30 && x.pm > 0).forEach(x => {
        if (!phase1WasteList.find(p => p.sku === x.sku)) {
            phase1WasteList.push({ sku: x.sku, asin: x.asin, wasted_spend: x.adSpend - x.rev * x.pm * 0.8, reason: 'å¹¿å‘Šå æ¯”' + pct(x.ar) + 'è¶…è¿‡æ¯›åˆ©ç‡' + pct(x.pm) + 'çš„2å€', suggested_action: 'negate', action_desc: 'å¦å®šä½æ•ˆè¯ï¼Œé¢„ç®—é™è‡³æ¯›åˆ©80%' });
        }
    });
    
    const phase1TotalSavings = phase1WasteList.reduce((a, x) => a + (x.wasted_spend > 0 ? x.wasted_spend : 0), 0);
    const phase1RatioReduction = s.rev > 0 ? phase1TotalSavings / s.rev : 0;
    const afterPhase1Ratio = Math.max(0, currentAdRatio - phase1RatioReduction);
    
    // Phase 1 æ±‡æ€»åŠ¨ä½œ
    const phase1Actions = [];
    const zeroAttrCount = phase1WasteList.filter(x => x.suggested_action === 'pause').length;
    const restructureCount = phase1WasteList.filter(x => x.suggested_action === 'restructure').length;
    const negateCount = phase1WasteList.filter(x => x.suggested_action === 'negate').length;
    
    if (zeroAttrCount > 0) phase1Actions.push({ action: 'æš‚åœé›¶å½’å› æŠ•æ”¾', skuCount: zeroAttrCount, spend: phase1WasteList.filter(x => x.suggested_action === 'pause').reduce((a, x) => a + x.wasted_spend, 0), impact: 'é”€é‡å½±å“â‰ˆ0ï¼ˆæœ¬æ¥å°±æ²¡æœ‰å½’å› ï¼‰' });
    if (restructureCount > 0) phase1Actions.push({ action: 'ç æ‰ACOS>300%æŠ•æ”¾80%', skuCount: restructureCount, spend: phase1WasteList.filter(x => x.suggested_action === 'restructure').reduce((a, x) => a + x.wasted_spend, 0), impact: 'é”€é‡å½±å“<3%ï¼ˆè¿™äº›æŠ•æ”¾ROIæå·®ï¼‰' });
    if (negateCount > 0) phase1Actions.push({ action: 'é™è¶…æ”¯SKUè‡³æ¯›åˆ©80%çº¿', skuCount: negateCount, spend: phase1WasteList.filter(x => x.suggested_action === 'negate').reduce((a, x) => a + x.wasted_spend, 0), impact: 'é”€é‡å½±å“5-8%' });
    
    // ========== Phase 2: å¢é‡ä¼˜åŒ–å‘¨è®¡åˆ’ï¼ˆç»“æ„åŒ–æ•°ç»„ï¼‰ ==========
    const phase2Gap = Math.max(0, afterPhase1Ratio - targetAdRatio);
    let phase2Plan = [];
    
    if (phase2Gap > 0) {
        const weeklyReduction = 0.015; // æ¯å‘¨é™1.5ä¸ªç™¾åˆ†ç‚¹
        const weeksNeeded = Math.ceil(phase2Gap / weeklyReduction);
        let tempRatio = afterPhase1Ratio;
        
        for (let w = 1; w <= Math.min(weeksNeeded, 12); w++) {
            const reduction = Math.min(weeklyReduction, tempRatio - targetAdRatio);
            if (reduction <= 0) break;
            tempRatio -= reduction;
            
            let actions = [];
            if (w === 1) actions = ['é™é•¿å°¾è¯ç«ä»·20%', 'å¦å®š7å¤©å†…æ— è½¬åŒ–è¯'];
            else if (w === 2) actions = ['å¦å®šACOS>ç›®æ ‡50%è¯', 'é™ä½è‡ªåŠ¨å¹¿å‘Šé¢„ç®—15%'];
            else if (w <= 4) actions = ['æ”¶ç¼©ä½æ•ˆcampaigné¢„ç®—', 'æš‚åœç‚¹å‡»>50æ— è®¢å•è¯'];
            else if (w <= 6) actions = ['ç»“æ„æ€§è°ƒæ•´ï¼šåˆå¹¶ç›¸ä¼¼campaign', 'æå‡æ ¸å¿ƒè¯å æ¯”'];
            else actions = ['æŒç»­ç›‘æ§è‡ªç„¶ä½å˜åŒ–', 'è‹¥æ’åä¸‹æ»‘æš‚åœç»§ç»­é™å¹…'];
            
            phase2Plan.push({
                week: w,
                target_ad_ratio: rd(tempRatio, 4),
                delta: rd(reduction, 4),
                daily_budget: rd(dailyRev * tempRatio, 2),
                actions: actions,
                checkpoint: w % 2 === 0 ? 'æ£€æŸ¥è‡ªç„¶æ’åä¸è‡ªç„¶å•é‡' : null
            });
        }
    }
    
    // ========== é”€é‡å½±å“åº¦ä¸‰æ¡£ä¼°ç®— ==========
    const impactPerPoint = {
        conservative: { rate: adDependency * 0.25, desc: 'ä¹è§‚åœºæ™¯ï¼šè‡ªç„¶æµé‡å¼ºï¼Œå¹¿å‘Šä¸»è¦åšå¢é‡' },
        moderate: { rate: adDependency * 0.5, desc: 'ä¸­æ€§åœºæ™¯ï¼šå¹¿å‘Šä¸è‡ªç„¶äº’ç›¸å½±å“' },
        aggressive: { rate: adDependency * 0.8, desc: 'æ‚²è§‚åœºæ™¯ï¼šé«˜åº¦ä¾èµ–å¹¿å‘Šæ‹‰åŠ¨æ’å' }
    };
    
    const totalReductionPct = gap * 100;
    const salesImpact = {
        conservative: rd(totalReductionPct * impactPerPoint.conservative.rate, 1),
        moderate: rd(totalReductionPct * impactPerPoint.moderate.rate, 1),
        aggressive: rd(totalReductionPct * impactPerPoint.aggressive.rate, 1)
    };
    
    // éçº¿æ€§é£é™©é˜ˆå€¼
    const riskThreshold = 5;
    const hasNonlinearRisk = totalReductionPct > riskThreshold;
    const riskWarning = hasNonlinearRisk ? `ç´¯è®¡é™å¹…>${riskThreshold}%ï¼Œå¯èƒ½è§¦å‘æ’åä¸‹æ»‘ã€‚å»ºè®®åˆ†é˜¶æ®µæ‰§è¡Œï¼Œæ¯é˜¶æ®µåè§‚å¯Ÿ3-5å¤©è‡ªç„¶ä½å˜åŒ–ã€‚` : null;
    
    return {
        runId, algoVersion: ALGO_VERSION, generatedAt: new Date().toISOString(),
        currentAdRatio, targetAdRatio, breakEvenAdRatio, needReduce, gap, adDependency,
        phase1: {
            wasteList: phase1WasteList,
            totalSavings: phase1TotalSavings,
            ratioReduction: phase1RatioReduction,
            afterRatio: afterPhase1Ratio,
            actions: phase1Actions,
            salesImpactAssumption: 'Phase1é’ˆå¯¹"æ— æ„ä¹‰æ¶ˆè€—"ï¼Œç†è®ºä¸Šè¿™äº›èŠ±è´¹å¯¹é”€é‡è´¡çŒ®æä½æˆ–ä¸ºé›¶ï¼Œå› æ­¤ç æ‰åé”€é‡å½±å“åº”<5%'
        },
        phase2: {
            gap: phase2Gap,
            plan: phase2Plan,
            weeksNeeded: phase2Plan.length
        },
        impact: {
            perPointPct: impactPerPoint,
            totalPct: salesImpact,
            formula: 'æ¯é™1%å¹¿å‘Šå æ¯” â†’ é”€é‡é™ (å¹¿å‘Šä¾èµ–åº¦Ã—ç³»æ•°)%'
        },
        riskThreshold,
        hasNonlinearRisk,
        riskWarning
    };
}

// ==================== ä»»åŠ¡1è¡¥é½: SKUçº§å¹¿å‘Šå»ºè®®ï¼ˆåŠ¨ä½œçº§ï¼‰ ====================
function generateSkuAdSuggestion(sku) {
    const suggestions = [];
    const targetAcos = sku.pm > 0 ? sku.pm * 0.8 : 0.3; // ç›®æ ‡ACOS = æ¯›åˆ©ç‡80%
    
    // 1. æ— å½’å› æŠ•æ”¾
    if (sku.adSpend > 30 && sku.adSales === 0) {
        suggestions.push({
            priority: 0,
            action_type: 'pause',
            action_desc: 'ç«‹å³æš‚åœæ‰€æœ‰å¹¿å‘Šæ´»åŠ¨',
            reason: `èŠ±è´¹$${sku.adSpend.toFixed(0)}æ— ä»»ä½•å½’å› é”€å”®`,
            expected_save: sku.adSpend,
            sales_impact: '0%ï¼ˆæœ¬æ¥å°±æ²¡æœ‰å½’å› ï¼‰'
        });
    }
    
    // 2. ACOSæé«˜
    else if (sku.acos > 2 && sku.adSpend > 20) {
        const targetBudget = sku.adSales > 0 ? sku.adSales * targetAcos : sku.adSpend * 0.2;
        suggestions.push({
            priority: 1,
            action_type: 'restructure',
            action_desc: `é¢„ç®—ä»$${sku.adSpend.toFixed(0)}é™è‡³$${targetBudget.toFixed(0)}`,
            reason: `ACOS ${pct(sku.acos)} è¿œè¶…ç›®æ ‡ ${pct(targetAcos)}`,
            expected_save: sku.adSpend - targetBudget,
            sales_impact: '<5%',
            sub_actions: [
                'æš‚åœACOS>300%çš„å¹¿å‘Šç»„',
                'å¦å®šç‚¹å‡»>30æ— è½¬åŒ–çš„è¯',
                'ä¿ç•™ACOS<ç›®æ ‡çš„æ ¸å¿ƒè¯'
            ]
        });
    }
    
    // 3. å¹¿å‘Šå æ¯”è¶…è¿‡æ¯›åˆ©ç‡
    else if (sku.ar > sku.pm && sku.adSpend > 0 && sku.pm > 0) {
        const targetSpend = sku.rev * sku.pm * 0.8;
        suggestions.push({
            priority: 1,
            action_type: 'reduce',
            action_desc: `é¢„ç®—ä»$${sku.adSpend.toFixed(0)}é™è‡³$${targetSpend.toFixed(0)}`,
            reason: `å¹¿å‘Šå æ¯” ${pct(sku.ar)} > æ¯›åˆ©ç‡ ${pct(sku.pm)}`,
            expected_save: Math.max(0, sku.adSpend - targetSpend),
            sales_impact: '5-10%',
            sub_actions: [
                'å¦å®šACOS>ç›®æ ‡50%çš„è¯',
                'é™ä½è‡ªåŠ¨å¹¿å‘Šç«ä»·20%',
                'é›†ä¸­é¢„ç®—åˆ°ACOSæœ€ä½çš„campaign'
            ]
        });
    }
    
    // 4. å¹¿å‘Šè´¡çŒ®ä¸ºè´Ÿä½†ACOSæ­£å¸¸
    else if (sku.adSales * sku.pm - sku.adSpend < 0 && sku.acos <= 1 && sku.adSpend > 50) {
        suggestions.push({
            priority: 2,
            action_type: 'optimize',
            action_desc: 'ä¼˜åŒ–å¹¿å‘Šç»“æ„ï¼Œæå‡è½¬åŒ–',
            reason: `å¹¿å‘Šè´¡çŒ®ä¸ºè´Ÿ$${(sku.adSales * sku.pm - sku.adSpend).toFixed(0)}`,
            expected_save: sku.adSpend * 0.2,
            sales_impact: '2-5%',
            sub_actions: [
                'åˆ†æè½¬åŒ–ç‡ä½çš„åŸå› ï¼ˆlisting/ç«äº‰/å‡ºä»·ï¼‰',
                'æµ‹è¯•æé«˜ç«ä»·20%çœ‹æ˜¯å¦æ”¹å–„è½¬åŒ–',
                'æ£€æŸ¥æ˜¯å¦éœ€è¦ä¼˜åŒ–listingå›¾ç‰‡/æ ‡é¢˜'
            ]
        });
    }
    
    // 5. å¥åº·çŠ¶æ€ï¼Œå¯æ”¾é‡
    else if (sku.acos > 0 && sku.acos < targetAcos * 0.8 && sku.ar < sku.pm * 0.7) {
        suggestions.push({
            priority: 3,
            action_type: 'scale_up',
            action_desc: `å¯å¢åŠ é¢„ç®—10-20%`,
            reason: `ACOS ${pct(sku.acos)} ä½äºç›®æ ‡ï¼Œå¹¿å‘Šå æ¯”å¥åº·`,
            expected_save: 0,
            sales_impact: '+5-15%å¢é‡',
            sub_actions: [
                'æé«˜æ ¸å¿ƒè¯ç«ä»·10%',
                'å¼€å¯æ–°çš„è‡ªåŠ¨å¹¿å‘Šæµ‹è¯•è¯',
                'å¢åŠ é¢„ç®—åˆ°è¡¨ç°æœ€å¥½çš„campaign'
            ]
        });
    }
    
    // 6. æ— å¹¿å‘ŠæŠ•æ”¾
    else if (sku.adSpend === 0 && sku.rev > 0) {
        suggestions.push({
            priority: 4,
            action_type: 'evaluate',
            action_desc: 'è¯„ä¼°æ˜¯å¦éœ€è¦æŠ•æ”¾å¹¿å‘Š',
            reason: 'å½“å‰æ— å¹¿å‘ŠæŠ•æ”¾',
            expected_save: 0,
            sales_impact: 'N/A',
            sub_actions: [
                'è‹¥è‡ªç„¶æ’åç¨³å®šå¯ç»§ç»­è§‚å¯Ÿ',
                'è‹¥æƒ³æ‰©é‡å¯å¼€å¯è‡ªåŠ¨å¹¿å‘Šæµ‹è¯•',
                'å»ºè®®æ—¥é¢„ç®—ä»$5å¼€å§‹'
            ]
        });
    }
    
    return {
        sku: sku.sku,
        asin: sku.asin,
        current_spend: sku.adSpend,
        current_acos: sku.acos,
        current_ar: sku.ar,
        target_acos: targetAcos,
        suggestions: suggestions,
        primary_action: suggestions[0] || null
    };
}

// ==================== ä»»åŠ¡3: ç»Ÿä¸€ResultBundle ====================
function buildResultBundle(s, skus, plan) {
    const timestamp = new Date().toISOString();
    const invData = skus.map(sku => ({ ...sku, inv: calcInventoryMetrics(sku) }));
    const diagnostics = skus.map(sku => generateSkuDiagnosis(sku));
    const adSuggestions = skus.filter(x => x.adSpend > 0 || x.rev > 500).map(sku => generateSkuAdSuggestion(sku));
    
    return {
        meta: {
            runId,
            algoVersion: ALGO_VERSION,
            generatedAt: timestamp,
            dataPeriodDays: s.days,
            skuCount: skus.length,
            filterApplied: s.isFiltered || false
        },
        summary: {
            rev: s.rev,
            units: s.units,
            pp: s.pp,
            pm: s.pm,
            adSpend: s.adSpend,
            adSales: s.adSales,
            ar: s.ar,
            op: s.op,
            om: s.om,
            np: s.np,
            npm: s.npm,
            acos: s.acos,
            roas: s.roas,
            adDependency: plan.adDependency,
            mfPeriod: s.mfPeriod,
            dailyBreakEven: s.dailyBreakEven
        },
        skus: skus.map(sku => ({
            ...sku,
            quadrant: classifySkuQuadrant(sku),
            role: getSkuRole(sku.sku),
            inv: calcInventoryMetrics(sku)
        })),
        ads: {
            storePlan: plan,
            skuSuggestions: adSuggestions
        },
        inventory: invData.map(x => ({
            sku: x.sku,
            asin: x.asin,
            ful: x.ful,
            inb: x.inb,
            rsv: x.rsv || 0,
            du: x.du,
            ...x.inv
        })),
        diagnostics: diagnostics,
        config: {
            invConfig: { ...INV_CONFIG },
            roleConfig: { ...SKU_ROLE_CONFIG }
        },
        checksums: {
            totalRev: skus.reduce((a, x) => a + x.rev, 0),
            totalOp: skus.reduce((a, x) => a + x.op, 0),
            summaryRev: s.rev,
            summaryOp: s.op,
            isConsistent: Math.abs(skus.reduce((a, x) => a + x.rev, 0) - s.rev) < 1
        }
    };
}

// ==================== ç­›é€‰æ±‡æ€» ====================
function calcFilteredSummary(filteredSkus) {
    if (!D || filteredSkus.length === 0) return { rev: 0, units: 0, pp: 0, op: 0, np: 0, adSpend: 0, adSales: 0, skuCount: 0, totalSkuCount: D ? D.skus.length : 0, isFiltered: true, isEmpty: true };
    const t = filteredSkus.reduce((a, s) => ({ rev: a.rev + s.rev, units: a.units + s.units, ref: a.ref + s.ref, fba: a.fba + s.fba, cogs: a.cogs + s.cogs, frt: a.frt + s.frt, rfmFee: a.rfmFee + s.rfmFee, pp: a.pp + s.pp, adSpend: a.adSpend + s.adSpend, op: a.op + s.op, imp: a.imp + (s.adImp || 0), clk: a.clk + (s.adClk || 0), adSales: a.adSales + s.adSales }), { rev: 0, units: 0, ref: 0, fba: 0, cogs: 0, frt: 0, rfmFee: 0, pp: 0, adSpend: 0, op: 0, imp: 0, clk: 0, adSales: 0 });
    const days = D.s.days, ratio = filteredSkus.length / D.skus.length, mfPeriod = D.s.mfPeriod * ratio;
    return { ...t, days, dRev: t.rev / days, pm: t.rev > 0 ? t.pp / t.rev : 0, ar: t.rev > 0 ? t.adSpend / t.rev : 0, om: t.rev > 0 ? t.op / t.rev : 0, np: t.op - mfPeriod, npm: t.rev > 0 ? (t.op - mfPeriod) / t.rev : 0, acos: t.adSales > 0 ? t.adSpend / t.adSales : 0, roas: t.adSpend > 0 ? t.adSales / t.adSpend : 0, ctr: t.imp > 0 ? t.clk / t.imp : 0, cpc: t.clk > 0 ? t.adSpend / t.clk : 0, mfPeriod, mfMonthly: D.s.mfMonthly, mfDaily: D.s.mfDaily, dailyBreakEven: t.op / days > 0 ? D.s.mfDaily / (t.op / t.rev) : 0, skuCount: filteredSkus.length, totalSkuCount: D.skus.length, isFiltered: filteredSkus.length !== D.skus.length, isEmpty: false };
}

function applyFilters() { const skus = FilterState.selectedSkus; return { skus, summary: calcFilteredSummary(skus) }; }

// ==================== åˆå§‹åŒ– ====================
const uz = document.getElementById('upload-zone'), fi = document.getElementById('file-input');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('dragover'); });
uz.addEventListener('dragleave', () => uz.classList.remove('dragover'));
uz.addEventListener('drop', e => { e.preventDefault(); uz.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
uz.addEventListener('click', () => fi.click());
fi.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

let searchDebounce;
document.getElementById('sku-search').addEventListener('input', e => {
    clearTimeout(searchDebounce);
    searchDebounce = setTimeout(() => { FilterState.querySku = e.target.value.trim(); renderAllWithFilter(); }, 200);
});

document.getElementById('lead-time-select').addEventListener('change', e => {
    INV_CONFIG.leadTimeDays = parseInt(e.target.value);
    if (D) renderAllWithFilter();
});

loadHistory();
loadSkuRoles();

async function handleFile(file) {
    document.getElementById('upload-status').classList.remove('hidden');
    document.getElementById('upload-error').classList.add('hidden');
    try {
        INV_CONFIG.leadTimeDays = parseInt(document.getElementById('lead-time-select').value);
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data);
        D = processWorkbook(wb);
        runId = 'run_' + Date.now().toString(36);
        allSkus = D.skus;
        categories = [...new Set(allSkus.map(x => x.cat).filter(x => x))];
        saveHistory(D);
        FilterState.querySku = '';
        document.getElementById('sku-search').value = '';
        overviewFilter = 'all';
        renderAllWithFilter();
        document.getElementById('upload-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
    } catch (err) {
        document.getElementById('upload-error').textContent = 'âŒ ' + err.message;
        document.getElementById('upload-error').classList.remove('hidden');
    } finally { document.getElementById('upload-status').classList.add('hidden'); }
}

function loadSkuRoles() { skuRoles = JSON.parse(localStorage.getItem(SKU_ROLES_KEY) || '{}'); }
function saveSkuRoles() { localStorage.setItem(SKU_ROLES_KEY, JSON.stringify(skuRoles)); }
function setSkuRole(sku, role) { skuRoles[sku] = role; saveSkuRoles(); renderAllWithFilter(); }
function getSkuRole(sku) { return skuRoles[sku] || 'profit'; }

function loadHistory() {
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    const section = document.getElementById('history-section'), list = document.getElementById('history-list');
    if (history.length > 0) {
        section.classList.remove('hidden');
        list.innerHTML = history.map((h, idx) => `<div class="panel p-3 flex justify-between items-center cursor-pointer hover:border-blue-500" onclick="showHistoryDetail(${idx})"><div><span class="text-tertiary text-sm">${h.time}</span><span class="text-primary ml-2">${h.s.days}å¤©</span><span class="text-tertiary ml-2">${h.config?.leadTimeDays||35}å¤©å¤´ç¨‹</span><span class="ml-2 ${h.s.np >= 0 ? 'text-success' : 'text-danger'}">${h.s.np >= 0 ? '+' : ''}$${h.s.np.toFixed(0)}</span></div><button onclick="event.stopPropagation();deleteHistory(${idx})" class="text-danger text-xs opacity-50 hover:opacity-100">åˆ é™¤</button></div>`).join('');
    } else { section.classList.add('hidden'); }
}

function saveHistory(data) {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    history.unshift({ time: new Date().toLocaleString('zh-CN'), s: { ...data.s }, skus: data.skus.map(sku => ({ ...sku })), fc: { ...data.fc }, config: { ...INV_CONFIG }, runId, algoVersion: ALGO_VERSION });
    if (history.length > 10) history = history.slice(0, 10);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function deleteHistory(idx) { if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); h.splice(idx, 1); localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); loadHistory(); } }
function showHistoryDetail(idx) { const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); if (idx >= history.length) return; currentHistoryIndex = idx; const h = history[idx]; document.getElementById('modal-title').textContent = `å†å² - ${h.time}`; document.getElementById('modal-content').innerHTML = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4">${[{ l: 'å‘¨æœŸ', v: h.s.days + 'å¤©' }, { l: 'å¤´ç¨‹', v: (h.config?.leadTimeDays || 35) + 'å¤©' }, { l: 'é”€å”®', v: '$' + h.s.rev.toFixed(0) }, { l: 'å‡€åˆ©æ¶¦', v: '$' + h.s.np.toFixed(0) }].map(x => `<div class="kpi-card"><p class="kpi-label">${x.l}</p><p class="kpi-value">${x.v}</p></div>`).join('')}</div>`; document.getElementById('history-modal').classList.remove('hidden'); }
function closeHistoryModal() { document.getElementById('history-modal').classList.add('hidden'); currentHistoryIndex = -1; }
function loadHistoryData(idx) { const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); if (idx >= history.length) return; D = { s: history[idx].s, skus: history[idx].skus, fc: history[idx].fc }; if (history[idx].config) { Object.assign(INV_CONFIG, history[idx].config); document.getElementById('lead-time-select').value = INV_CONFIG.leadTimeDays; } runId = history[idx].runId || 'run_' + Date.now().toString(36); allSkus = D.skus; closeHistoryModal(); FilterState.querySku = ''; document.getElementById('sku-search').value = ''; renderAllWithFilter(); document.getElementById('upload-section').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden'); }
function clearAllHistory() { if (confirm('æ¸…é™¤æ‰€æœ‰ï¼Ÿ')) { localStorage.removeItem(HISTORY_KEY); loadHistory(); } }

function updateFilterBadge(summary) {
    const badge = document.getElementById('filter-badge');
    if (summary.isFiltered && !summary.isEmpty) { badge.innerHTML = `<span class="badge badge-info">${summary.skuCount}/${summary.totalSkuCount} SKU</span>`; badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }
}

// ==================== ç»Ÿä¸€æ¸²æŸ“å…¥å£ ====================
function renderAllWithFilter() {
    const { skus, summary: s } = applyFilters();
    updateFilterBadge(s);
    document.getElementById('period-label').textContent = `å‘¨æœŸ ${D.s.days}å¤© Â· å¤´ç¨‹ ${INV_CONFIG.leadTimeDays}å¤© Â· Run ${runId}`;
    
    const al = document.getElementById('alert-banner');
    if (s.isEmpty) { al.innerHTML = `<div class="alert alert-info"><span>æœªæ‰¾åˆ°åŒ¹é…çš„SKU</span></div>`; }
    else { al.innerHTML = `<div class="alert ${s.np < 0 ? 'alert-critical' : 'alert-success'}"><span class="text-2xl">${s.np < 0 ? 'âš ï¸' : 'âœ…'}</span><div><p class="font-semibold">${s.isFiltered ? 'ç­›é€‰èŒƒå›´' : 'å…¨åº—'}${D.s.days}å¤©${s.np < 0 ? 'äºæŸ' : 'ç›ˆåˆ©'}: ${$(Math.abs(s.np))}</p><p class="text-secondary text-sm">ç»è¥æ¯›åˆ© ${$(s.op)} âˆ’ å›ºå®šæˆæœ¬ ${$(s.mfPeriod)} = å‡€åˆ©æ¶¦ ${$(s.np)}</p></div></div>`; }
    
    renderRedlineAlerts(s, skus);
    renderOverview(skus, s);
    renderDecisionCenter(skus, s);
    renderProfit(skus, s);
    renderAds(skus, s);
    renderInventory(skus, s);
    renderConfig(skus, s);
    renderCharts(s, skus);
}

function renderRedlineAlerts(s, skus) {
    let alerts = [];
    if (s.ar > s.pm && !s.isEmpty) alerts.push({ level: 'critical', text: `å¹¿å‘Šå æ¯” ${pct(s.ar)} è¶…è¿‡æ¯›åˆ©ç‡ ${pct(s.pm)}`, action: 'æ‰§è¡ŒPhase1ç æ— æ„ä¹‰æ¶ˆè€—' });
    if (s.np < 0 && !s.isEmpty) alerts.push({ level: 'warning', text: `å‡€åˆ©æ¶¦ä¸ºè´Ÿ $${s.np.toFixed(0)}`, action: 'å…¨é¢å¤ç›˜æˆæœ¬ä¸å¹¿å‘Š' });
    const critical = skus.filter(x => calcInventoryMetrics(x).status === 'critical');
    if (critical.length > 0) alerts.push({ level: 'warning', text: `${critical.length} ä¸ªSKUå¯å”®åº“å­˜ < ${INV_CONFIG.lowStockThreshold}å¤©`, action: 'ç´§æ€¥è¡¥è´§' });
    document.getElementById('redline-alerts').innerHTML = alerts.map(a => `<div class="alert alert-${a.level}"><span class="text-xl">${a.level === 'critical' ? 'ğŸš¨' : 'âš ï¸'}</span><div class="flex-1"><span>${a.text}</span></div><span class="text-tertiary text-sm">${a.action}</span></div>`).join('');
}

// ==================== æ¦‚è§ˆæ¸²æŸ“ ====================
function renderOverview(skus, s) {
    if (s.isEmpty) { document.getElementById('tab-overview').innerHTML = '<div class="panel p-8 text-center text-secondary">æ— åŒ¹é…SKU</div>'; return; }
    const filterNote = s.isFiltered ? `<div class="alert alert-info mb-4"><span>ç­›é€‰ç»“æœ (${s.skuCount}/${s.totalSkuCount} SKU)</span></div>` : '';
    
    let displaySkus = [...skus];
    if (overviewFilter === 'loss') displaySkus = skus.filter(x => x.op < 0);
    else if (overviewFilter === 'high-ad') displaySkus = skus.filter(x => x.ar > x.pm && x.adSpend > 0);
    else if (overviewFilter === 'low-inv') displaySkus = skus.filter(x => { const m = calcInventoryMetrics(x); return m.status === 'critical' || m.status === 'reorder-now'; });
    else if (overviewFilter === 'no-sales') displaySkus = skus.filter(x => x.du <= 0);
    
    displaySkus.sort((a, b) => {
        let va, vb;
        if (overviewSort.field === 'rev') { va = a.rev; vb = b.rev; }
        else if (overviewSort.field === 'op') { va = a.op; vb = b.op; }
        else if (overviewSort.field === 'ar') { va = a.ar; vb = b.ar; }
        else if (overviewSort.field === 'pm') { va = a.pm; vb = b.pm; }
        else if (overviewSort.field === 'dos') { const ma = calcInventoryMetrics(a), mb = calcInventoryMetrics(b); va = ma.sellableDOS ?? 9999; vb = mb.sellableDOS ?? 9999; }
        else { va = a.op; vb = b.op; }
        return overviewSort.asc ? va - vb : vb - va;
    });
    
    const pro = skus.filter(x => x.op > 0), los = skus.filter(x => x.op < 0), noSales = skus.filter(x => x.du <= 0);
    
    document.getElementById('tab-overview').innerHTML = filterNote + `
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="kpi-card"><p class="kpi-label">å‡€é”€å”®</p><p class="kpi-value positive">${$(s.rev)}</p><p class="kpi-sub">${s.units} å•</p></div>
        <div class="kpi-card"><p class="kpi-label">å®šä»·æ¯›åˆ©</p><p class="kpi-value">${$(s.pp)}</p><p class="kpi-sub">${pct(s.pm)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å¹¿å‘ŠèŠ±è´¹</p><p class="kpi-value" style="color: var(--accent-warning);">${$(s.adSpend)}</p><p class="kpi-sub">${pct(s.ar)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å‡€åˆ©æ¶¦</p><p class="kpi-value ${s.np >= 0 ? 'positive' : 'negative'}">${$(s.np)}</p><p class="kpi-sub">${pct(s.npm)}</p></div>
        ${s.om > 0 ? `<div class="kpi-card"><p class="kpi-label">æ—¥ç›ˆäºå¹³è¡¡</p><p class="kpi-value" style="color: var(--accent-info);">${$(s.dailyBreakEven)}</p></div>` : ''}
    </div>
    <div class="grid md:grid-cols-2 gap-6">
        <div class="panel"><div class="panel-header"><span class="font-semibold">Top 10 SKU ç»è¥åˆ©æ¶¦</span></div><div class="panel-body"><canvas id="chart1" height="280"></canvas></div></div>
        <div class="panel"><div class="panel-header"><span class="font-semibold">æˆæœ¬ç»“æ„</span></div><div class="panel-body"><canvas id="chart2" height="280"></canvas></div></div>
    </div>
    <div class="panel">
        <div class="panel-header flex justify-between items-center flex-wrap gap-3">
            <span class="font-semibold">SKU å¥åº·åº¦ <span class="text-secondary font-normal">(ç›ˆåˆ© ${pro.length} / äºæŸ ${los.length} / æ— é”€é‡ ${noSales.length})</span></span>
            <div class="flex gap-2 flex-wrap">
                <span class="chip ${overviewFilter === 'all' ? 'active' : ''}" onclick="setOverviewFilter('all')">å…¨éƒ¨ (${skus.length})</span>
                <span class="chip ${overviewFilter === 'loss' ? 'active' : ''}" onclick="setOverviewFilter('loss')">äºæŸ (${los.length})</span>
                <span class="chip ${overviewFilter === 'high-ad' ? 'active' : ''}" onclick="setOverviewFilter('high-ad')">é«˜å¹¿å‘Š</span>
                <span class="chip ${overviewFilter === 'low-inv' ? 'active' : ''}" onclick="setOverviewFilter('low-inv')">ä½åº“å­˜</span>
                <span class="chip ${overviewFilter === 'no-sales' ? 'active' : ''}" onclick="setOverviewFilter('no-sales')">æ— é”€é‡</span>
            </div>
        </div>
        <div class="overflow-auto" style="max-height: 400px;">
            <table class="data-table">
                <thead><tr><th>SKU</th><th class="text-right sortable" onclick="setOverviewSort('rev')">é”€å”®é¢ ${overviewSort.field === 'rev' ? (overviewSort.asc ? 'â†‘' : 'â†“') : ''}</th><th class="text-right sortable" onclick="setOverviewSort('pm')">æ¯›åˆ©ç‡ ${overviewSort.field === 'pm' ? (overviewSort.asc ? 'â†‘' : 'â†“') : ''}</th><th class="text-right sortable" onclick="setOverviewSort('ar')">å¹¿å‘Šå æ¯” ${overviewSort.field === 'ar' ? (overviewSort.asc ? 'â†‘' : 'â†“') : ''}</th><th class="text-right sortable" onclick="setOverviewSort('op')">ç»è¥åˆ©æ¶¦ ${overviewSort.field === 'op' ? (overviewSort.asc ? 'â†‘' : 'â†“') : ''}</th><th class="text-right sortable" onclick="setOverviewSort('dos')">Sellable DOS ${overviewSort.field === 'dos' ? (overviewSort.asc ? 'â†‘' : 'â†“') : ''}</th><th>åº“å­˜çŠ¶æ€</th></tr></thead>
                <tbody>${displaySkus.map(r => { const inv = calcInventoryMetrics(r); return `<tr><td class="text-primary">${r.sku.substring(0, 20)}</td><td class="text-right">${$(r.rev)}</td><td class="text-right ${r.pm < 0 ? 'negative' : ''}">${pct(r.pm)}</td><td class="text-right ${r.ar > r.pm ? 'negative' : ''}">${pct(r.ar)}</td><td class="text-right ${r.op >= 0 ? 'positive' : 'negative'}">${$(r.op)}</td><td class="text-right ${inv.statusColor === 'danger' ? 'negative' : ''}">${formatDOS(inv.sellableDOS)}</td><td>${getInvStatusBadge(inv)}</td></tr>`; }).join('')}</tbody>
            </table>
        </div>
    </div>`;
}

function setOverviewFilter(f) { overviewFilter = f; renderAllWithFilter(); }
function setOverviewSort(field) { if (overviewSort.field === field) overviewSort.asc = !overviewSort.asc; else { overviewSort.field = field; overviewSort.asc = false; } renderAllWithFilter(); }

// ==================== å†³ç­–ä¸­å¿ƒæ¸²æŸ“ ====================
function renderDecisionCenter(skus, s) {
    if (s.isEmpty) { document.getElementById('tab-decision').innerHTML = '<div class="panel p-8 text-center text-secondary">æ— åŒ¹é…SKU</div>'; return; }
    const plan = generateAdOptimizationPlan(s, skus);
    const quadrants = { star: [], question: [], dog: [], eliminate: [] };
    skus.forEach(sku => { quadrants[classifySkuQuadrant(sku)].push(sku); });
    const problemSkus = skus.filter(sku => { const d = generateSkuDiagnosis(sku); return !d.isHealthy || d.issues.length > 0; }).slice(0, 30);
    
    document.getElementById('tab-decision').innerHTML = `
    <div class="grid md:grid-cols-3 gap-4">
        <div class="kpi-card"><p class="kpi-label">å¹¿å‘Šè´¡çŒ®åˆ©æ¶¦</p><p class="kpi-value ${s.adSales * s.pm - s.adSpend >= 0 ? 'positive' : 'negative'}">$${(s.adSales * s.pm - s.adSpend).toFixed(0)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å¹¿å‘Šä¾èµ–åº¦</p><p class="kpi-value" style="color: ${plan.adDependency > 0.7 ? 'var(--accent-warning)' : 'inherit'};">${pct(plan.adDependency)}</p></div>
        <div class="kpi-card"><p class="kpi-label">éœ€è°ƒæ•´å¹…åº¦</p><p class="kpi-value" style="color: ${plan.needReduce ? 'var(--accent-warning)' : 'var(--accent-success)'};">${plan.needReduce ? '-' + (plan.gap * 100).toFixed(1) + 'ç‚¹' : 'æ— éœ€'}</p></div>
    </div>
    <div class="panel"><div class="panel-header"><span class="font-semibold">SKU å››è±¡é™</span></div><div class="panel-body"><div class="grid md:grid-cols-2 gap-4"><div class="quadrant-grid"><div class="quadrant-cell" style="background: rgba(48,209,88,0.1);"><span class="font-semibold" style="color: var(--accent-success);">ğŸŸ¢ æ˜æ˜Ÿ ${quadrants.star.length}</span><p class="text-tertiary text-sm mt-1">å¯æ”¾é‡</p></div><div class="quadrant-cell" style="background: rgba(255,159,10,0.1);"><span class="font-semibold" style="color: var(--accent-warning);">ğŸŸ¡ é—®é¢˜ ${quadrants.question.length}</span><p class="text-tertiary text-sm mt-1">è¯Šæ–­æˆæœ¬</p></div><div class="quadrant-cell" style="background: rgba(255,159,10,0.1);"><span class="font-semibold" style="color: var(--accent-warning);">ğŸŸ  ç˜¦ç‹— ${quadrants.dog.length}</span><p class="text-tertiary text-sm mt-1">ä¼˜åŒ–å¹¿å‘Š</p></div><div class="quadrant-cell" style="background: rgba(255,69,58,0.1);"><span class="font-semibold" style="color: var(--accent-danger);">ğŸ”´ æ·˜æ±° ${quadrants.eliminate.length}</span><p class="text-tertiary text-sm mt-1">è€ƒè™‘é€€å‡º</p></div></div><div><canvas id="quadrant-chart" height="160"></canvas></div></div></div></div>
    <div class="panel"><div class="panel-header"><span class="font-semibold">ğŸ“‹ SKU è§’è‰²è¯´æ˜</span></div><div class="panel-body"><div class="grid md:grid-cols-4 gap-4">${Object.entries(SKU_ROLE_CONFIG).map(([k, v]) => `<div class="p-4 rounded-lg" style="background: var(--bg-hover);"><p class="font-semibold badge badge-${v.color}">${v.name}</p><p class="text-tertiary text-xs mt-2">å…è®¸äºæŸ: ${pct(v.allowedLoss)}</p><p class="text-tertiary text-xs">æ­¢æŸçº¿: ${pct(v.stopLoss)}</p>${v.windowWeeks ? `<p class="text-tertiary text-xs">çª—å£: ${v.windowWeeks}å‘¨</p>` : ''}<p class="text-secondary text-xs mt-2">${v.desc}</p></div>`).join('')}</div></div></div>
    <div class="panel"><div class="panel-header"><span class="font-semibold">ğŸ” SKU è¯Šæ–­ä¸å»ºè®® <span class="text-secondary font-normal">(${problemSkus.length} ä¸ªéœ€å…³æ³¨)</span></span></div><div class="panel-body"><div class="overflow-auto" style="max-height: 400px;"><table class="data-table"><thead><tr><th>SKU</th><th>è±¡é™</th><th>è§’è‰²</th><th class="text-right">æ¯›åˆ©ç‡</th><th class="text-right">å¹¿å‘Šè´¡çŒ®</th><th>é—®é¢˜æ•°</th><th>é¦–è¦å»ºè®®</th><th>æ“ä½œ</th></tr></thead><tbody>${problemSkus.map(sku => { const d = generateSkuDiagnosis(sku); const firstAction = d.actions[0]?.text.substring(0, 25) || '-'; return `<tr><td class="text-primary">${sku.sku.substring(0, 15)}</td><td><span class="badge badge-${d.qInfo.color}">${d.qInfo.icon} ${d.qInfo.name}</span></td><td><select onchange="setSkuRole('${sku.sku}',this.value)" class="input text-xs py-1 px-2">${Object.entries(SKU_ROLE_CONFIG).map(([k, v]) => `<option value="${k}" ${d.role === k ? 'selected' : ''}>${v.name}</option>`).join('')}</select></td><td class="text-right ${sku.pm >= 0 ? 'positive' : 'negative'}">${pct(sku.pm)}</td><td class="text-right ${d.adContrib >= 0 ? 'positive' : 'negative'}">$${d.adContrib.toFixed(0)}</td><td>${d.isHealthy ? '<span class="positive">âœ“</span>' : `<span class="negative">${d.issues.length}ä¸ª</span>`}</td><td class="text-tertiary text-xs">${firstAction}...</td><td><button onclick="showSkuDetail('${sku.sku}')" class="btn btn-secondary text-xs py-1 px-2">è¯Šæ–­</button></td></tr>`; }).join('')}</tbody></table></div></div></div>`;
    
    setTimeout(() => {
        if (charts.quadrant) charts.quadrant.destroy();
        const ctx = document.getElementById('quadrant-chart');
        if (ctx) charts.quadrant = new Chart(ctx, { type: 'doughnut', data: { labels: ['æ˜æ˜Ÿ', 'é—®é¢˜', 'ç˜¦ç‹—', 'æ·˜æ±°'], datasets: [{ data: [quadrants.star.length, quadrants.question.length, quadrants.dog.length, quadrants.eliminate.length], backgroundColor: ['#30d158', '#ff9f0a', '#ff9f0a', '#ff453a'] }] }, options: { plugins: { legend: { position: 'right', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') } } } } });
    }, 100);
}

function showSkuDetail(skuCode) {
    const sku = allSkus.find(x => x.sku === skuCode);
    if (!sku) return;
    const d = generateSkuDiagnosis(sku);
    document.getElementById('sku-modal-title').textContent = `SKU è¯Šæ–­ - ${skuCode}`;
    document.getElementById('sku-modal-content').innerHTML = `
    <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="kpi-card"><p class="kpi-label">è±¡é™</p><p class="kpi-value"><span class="badge badge-${d.qInfo.color}">${d.qInfo.icon} ${d.qInfo.name}</span></p></div>
            <div class="kpi-card"><p class="kpi-label">è§’è‰²</p><p class="kpi-value"><span class="badge badge-${d.roleConfig.color}">${d.roleConfig.name}</span></p><p class="text-tertiary text-xs mt-1">${d.roleConfig.desc.substring(0, 30)}...</p></div>
        </div>
        <div class="grid grid-cols-4 gap-3">
            <div class="kpi-card"><p class="kpi-label">é”€å”®é¢</p><p class="kpi-value text-lg">${$(sku.rev)}</p></div>
            <div class="kpi-card"><p class="kpi-label">æ¯›åˆ©ç‡</p><p class="kpi-value text-lg ${sku.pm >= 0 ? 'positive' : 'negative'}">${pct(sku.pm)}</p></div>
            <div class="kpi-card"><p class="kpi-label">å¹¿å‘Šå æ¯”</p><p class="kpi-value text-lg ${sku.ar > sku.pm ? 'negative' : ''}">${pct(sku.ar)}</p></div>
            <div class="kpi-card"><p class="kpi-label">å¹¿å‘Šè´¡çŒ®</p><p class="kpi-value text-lg ${d.adContrib >= 0 ? 'positive' : 'negative'}">$${d.adContrib.toFixed(0)}</p></div>
        </div>
        ${d.issues.length > 0 ? `<div class="alert alert-critical"><div><p class="font-semibold">âš ï¸ é—®é¢˜è¯Šæ–­ (${d.issues.length})</p><ul class="mt-2 space-y-1">${d.issues.map(i => `<li class="text-sm">${i.type === 'critical' ? 'ğŸ”´' : 'ğŸŸ '} ${i.text}</li>`).join('')}</ul></div></div>` : '<div class="alert alert-success"><span class="positive">âœ… æœªå‘ç°é—®é¢˜</span></div>'}
        ${d.actions.length > 0 ? `<div class="alert alert-info"><div><p class="font-semibold">ğŸ“‹ å»ºè®®åŠ¨ä½œ (${d.actions.length})</p><div class="mt-2 space-y-2">${d.actions.map(a => `<div class="pb-2 border-b" style="border-color: var(--border-subtle);"><p class="text-primary">${a.text}</p><p class="text-tertiary text-xs mt-1">å‰æ: ${a.condition}</p></div>`).join('')}</div></div></div>` : ''}
        ${d.stopLoss.length > 0 ? `<div class="alert alert-warning"><div><p class="font-semibold">ğŸ›‘ æ­¢æŸæ¡ä»¶</p><ul class="mt-2 space-y-1">${d.stopLoss.map(s => `<li class="text-sm">â€¢ ${s}</li>`).join('')}</ul></div></div>` : ''}
        <div class="panel"><div class="panel-body"><p class="font-semibold mb-2">ğŸ“¦ åº“å­˜çŠ¶æ€</p><div class="grid grid-cols-3 gap-3 text-sm"><div><span class="text-tertiary">å¯å”®:</span> ${sku.ful}</div><div><span class="text-tertiary">åœ¨é€”:</span> ${sku.inb}</div><div><span class="text-tertiary">Sellable DOS:</span> <span class="${d.inv.statusColor === 'danger' ? 'negative' : ''}">${formatDOS(d.inv.sellableDOS)}</span></div></div><div class="mt-2">${getInvStatusBadge(d.inv)}</div></div></div>
    </div>`;
    document.getElementById('sku-detail-modal').classList.remove('hidden');
}
function closeSkuModal() { document.getElementById('sku-detail-modal').classList.add('hidden'); }

// ==================== åˆ©æ¶¦åˆ†ææ¸²æŸ“ ====================
function renderProfit(skus, s) {
    if (s.isEmpty) { document.getElementById('tab-profit').innerHTML = '<div class="panel p-8 text-center text-secondary">æ— åŒ¹é…SKU</div>'; return; }
    const tc = s.ref + s.fba + s.cogs + s.frt + s.rfmFee;
    const pro = skus.filter(x => x.op > 0).sort((a, b) => b.op - a.op);
    const los = skus.filter(x => x.op < 0).sort((a, b) => a.op - b.op);
    
    document.getElementById('tab-profit').innerHTML = `
    <div class="grid md:grid-cols-4 gap-4">
        <div class="kpi-card"><p class="kpi-label">å‡€é”€å”®</p><p class="kpi-value positive">${$(s.rev)}</p></div>
        <div class="kpi-card"><p class="kpi-label">æ€»æˆæœ¬</p><p class="kpi-value" style="color: var(--accent-warning);">${$(tc)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å®šä»·æ¯›åˆ©</p><p class="kpi-value">${$(s.pp)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å‡€åˆ©æ¶¦</p><p class="kpi-value ${s.np >= 0 ? 'positive' : 'negative'}">${$(s.np)}</p></div>
    </div>
    <div class="panel"><div class="panel-header"><span class="font-semibold">åˆ©æ¶¦ç€‘å¸ƒ</span></div><div class="panel-body"><canvas id="chart3" height="250"></canvas></div></div>
    <div class="grid md:grid-cols-2 gap-4">
        <div class="panel" style="border-color: rgba(48,209,88,0.3);"><div class="panel-header"><span class="font-semibold positive">ğŸ’° ç›ˆåˆ© SKU Top 10 <span class="text-secondary font-normal">(å…± ${pro.length} ä¸ª)</span></span></div><div class="panel-body"><div class="overflow-auto" style="max-height: 280px;"><table class="data-table"><thead><tr><th>SKU</th><th class="text-right">é”€å”®</th><th class="text-right">æ¯›åˆ©ç‡</th><th class="text-right">ç»è¥åˆ©æ¶¦</th></tr></thead><tbody>${pro.slice(0, 10).map(r => `<tr><td class="text-primary">${r.sku.substring(0, 15)}</td><td class="text-right">${$(r.rev)}</td><td class="text-right">${pct(r.pm)}</td><td class="text-right positive">${$(r.op)}</td></tr>`).join('')}</tbody></table></div></div></div>
        <div class="panel" style="border-color: rgba(255,69,58,0.3);"><div class="panel-header"><span class="font-semibold negative">ğŸ“‰ äºæŸ SKU Top 10 <span class="text-secondary font-normal">(å…± ${los.length} ä¸ª)</span></span></div><div class="panel-body"><div class="overflow-auto" style="max-height: 280px;"><table class="data-table"><thead><tr><th>SKU</th><th class="text-right">é”€å”®</th><th class="text-right">æ¯›åˆ©ç‡</th><th class="text-right">ç»è¥åˆ©æ¶¦</th></tr></thead><tbody>${los.slice(0, 10).map(r => `<tr><td class="text-primary">${r.sku.substring(0, 15)}</td><td class="text-right">${$(r.rev)}</td><td class="text-right ${r.pm < 0 ? 'negative' : ''}">${pct(r.pm)}</td><td class="text-right negative">${$(r.op)}</td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

// ==================== å¹¿å‘Šç®¡ç†æ¸²æŸ“ (ä»»åŠ¡1æ ¸å¿ƒ) ====================
function renderAds(skus, s) {
    if (s.isEmpty) { document.getElementById('tab-ads').innerHTML = '<div class="panel p-8 text-center text-secondary">æ— åŒ¹é…SKU</div>'; return; }
    const plan = generateAdOptimizationPlan(s, skus);
    
    document.getElementById('tab-ads').innerHTML = `
    <div class="grid md:grid-cols-4 gap-4">
        <div class="kpi-card"><p class="kpi-label">å¹¿å‘ŠèŠ±è´¹</p><p class="kpi-value">${$(s.adSpend)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å½’å› é”€å”®</p><p class="kpi-value positive">${$(s.adSales)}</p></div>
        <div class="kpi-card"><p class="kpi-label">å¹¿å‘Šå æ¯”</p><p class="kpi-value ${s.ar > s.pm ? 'negative' : ''}" style="color: var(--accent-warning);">${pct(s.ar)}</p></div>
        <div class="kpi-card"><p class="kpi-label">ROAS</p><p class="kpi-value">${s.roas.toFixed(2)}</p></div>
    </div>
    
    <div class="panel"><div class="panel-header"><span class="font-semibold">ğŸ“Š å¹¿å‘Šå æ¯”åˆ†æ</span></div><div class="panel-body"><div class="grid md:grid-cols-4 gap-4"><div class="kpi-card"><p class="kpi-label">å½“å‰</p><p class="kpi-value text-lg ${plan.currentAdRatio > plan.breakEvenAdRatio ? 'negative' : ''}">${pct(plan.currentAdRatio)}</p></div><div class="kpi-card"><p class="kpi-label">ç›ˆäºçº¿</p><p class="kpi-value text-lg" style="color: var(--accent-info);">${pct(plan.breakEvenAdRatio)}</p></div><div class="kpi-card"><p class="kpi-label">ç›®æ ‡</p><p class="kpi-value text-lg positive">${pct(plan.targetAdRatio)}</p></div><div class="kpi-card"><p class="kpi-label">å¹¿å‘Šä¾èµ–åº¦</p><p class="kpi-value text-lg ${plan.adDependency > 0.7 ? '' : ''}" style="color: ${plan.adDependency > 0.7 ? 'var(--accent-warning)' : 'inherit'};">${pct(plan.adDependency)}</p></div></div></div></div>
    
    <!-- Phase 1: æ— æ„ä¹‰æ¶ˆè€—æ¸…å• -->
    <div class="panel" style="border-color: rgba(255,159,10,0.3);"><div class="panel-header"><span class="font-semibold" style="color: var(--accent-warning);">ğŸ”¥ Phase 1: ç æ— æ„ä¹‰æ¶ˆè€— <span class="text-secondary font-normal">(å¯¹é”€é‡å½±å“ â‰ˆ 0)</span></span></div><div class="panel-body">
        ${plan.phase1.wasteList.length > 0 ? `
        <div class="overflow-auto mb-4" style="max-height: 280px;">
            <table class="data-table"><thead><tr><th>SKU</th><th>æµªè´¹é‡‘é¢</th><th>åŸå› </th><th>å»ºè®®åŠ¨ä½œ</th></tr></thead>
            <tbody>${plan.phase1.wasteList.slice(0, 20).map(w => `<tr><td class="text-primary">${w.sku.substring(0, 15)}</td><td class="text-right negative">$${w.wasted_spend.toFixed(0)}</td><td class="text-tertiary text-xs">${w.reason}</td><td><span class="badge badge-${w.suggested_action === 'pause' ? 'danger' : w.suggested_action === 'restructure' ? 'warning' : 'info'}">${w.action_desc}</span></td></tr>`).join('')}</tbody>
            </table>
        </div>
        <div class="alert alert-success"><div><p class="positive font-semibold">âœ… Phase1 é¢„è®¡èŠ‚çœ: ${$(plan.phase1.totalSavings)} <span class="text-secondary font-normal">(å æ¯”ä¸‹é™ ${pct(plan.phase1.ratioReduction)})</span></p><p class="text-secondary text-sm mt-1">æ‰§è¡Œåå¹¿å‘Šå æ¯”: ${pct(plan.currentAdRatio)} â†’ ${pct(plan.phase1.afterRatio)}</p><p class="text-tertiary text-xs mt-2">${plan.phase1.salesImpactAssumption}</p></div></div>
        ` : '<p class="text-secondary">æœªå‘ç°æ˜æ˜¾æ— æ„ä¹‰æ¶ˆè€— âœ“</p>'}
    </div></div>
    
    <!-- Phase 2: å¢é‡ä¼˜åŒ–å‘¨è®¡åˆ’ -->
    ${plan.phase2.gap > 0 ? `
    <div class="panel" style="border-color: rgba(0,113,227,0.3);"><div class="panel-header"><span class="font-semibold" style="color: var(--accent-primary);">ğŸ“… Phase 2: å¢é‡ä¼˜åŒ–å‘¨è®¡åˆ’ <span class="text-secondary font-normal">(éœ€ ${plan.phase2.weeksNeeded} å‘¨)</span></span></div><div class="panel-body">
        <div class="overflow-auto mb-4">
            <table class="data-table"><thead><tr><th>å‘¨æ¬¡</th><th class="text-right">ç›®æ ‡å æ¯”</th><th class="text-right">é™å¹…</th><th class="text-right">æ—¥é¢„ç®—</th><th>æ‰§è¡ŒåŠ¨ä½œ</th><th>æ£€æŸ¥ç‚¹</th></tr></thead>
            <tbody>${plan.phase2.plan.map(p => `<tr><td class="text-primary">Week ${p.week}</td><td class="text-right">${pct(p.target_ad_ratio)}</td><td class="text-right" style="color: var(--accent-warning);">-${pct(p.delta)}</td><td class="text-right">${$(p.daily_budget)}/å¤©</td><td class="text-tertiary text-xs">${p.actions.join(', ')}</td><td class="text-tertiary text-xs">${p.checkpoint || '-'}</td></tr>`).join('')}</tbody>
            </table>
        </div>
    </div></div>` : ''}
    
    <!-- é”€é‡å½±å“åº¦ä¼°ç®— -->
    <div class="panel"><div class="panel-header"><span class="font-semibold">ğŸ“ˆ é”€é‡å½±å“åº¦ä¼°ç®— <span class="text-secondary font-normal">(åŸºäºå¹¿å‘Šä¾èµ–åº¦ ${pct(plan.adDependency)})</span></span></div><div class="panel-body">
        <div class="grid md:grid-cols-3 gap-4 mb-4">
            <div class="alert alert-success"><div><p class="kpi-label">ä¿å®ˆä¼°è®¡</p><p class="text-primary">æ¯é™1%å¹¿å‘Šå æ¯” â†’ é”€é‡é™ ${pct(plan.impact.perPointPct.conservative.rate)}</p><p class="positive text-sm mt-2">æ€»é™å¹…é¢„ä¼°: ${plan.impact.totalPct.conservative}%</p><p class="text-tertiary text-xs mt-1">${plan.impact.perPointPct.conservative.desc}</p></div></div>
            <div class="alert alert-info"><div><p class="kpi-label">ä¸­æ€§ä¼°è®¡</p><p class="text-primary">æ¯é™1%å¹¿å‘Šå æ¯” â†’ é”€é‡é™ ${pct(plan.impact.perPointPct.moderate.rate)}</p><p style="color: var(--accent-info);" class="text-sm mt-2">æ€»é™å¹…é¢„ä¼°: ${plan.impact.totalPct.moderate}%</p><p class="text-tertiary text-xs mt-1">${plan.impact.perPointPct.moderate.desc}</p></div></div>
            <div class="alert alert-warning"><div><p class="kpi-label">æ¿€è¿›ä¼°è®¡</p><p class="text-primary">æ¯é™1%å¹¿å‘Šå æ¯” â†’ é”€é‡é™ ${pct(plan.impact.perPointPct.aggressive.rate)}</p><p style="color: var(--accent-warning);" class="text-sm mt-2">æ€»é™å¹…é¢„ä¼°: ${plan.impact.totalPct.aggressive}%</p><p class="text-tertiary text-xs mt-1">${plan.impact.perPointPct.aggressive.desc}</p></div></div>
        </div>
        ${plan.hasNonlinearRisk ? `<div class="alert alert-critical"><span>âš ï¸ ${plan.riskWarning}</span></div>` : `<div class="alert alert-success"><span class="positive">âœ… è°ƒæ•´å¹…åº¦åœ¨å®‰å…¨èŒƒå›´å†… (< ${plan.riskThreshold}%)</span></div>`}
    </div></div>`;
}

// ==================== åº“å­˜ç®¡ç†æ¸²æŸ“ ====================
function renderInventory(skus, s) {
    if (s.isEmpty) { document.getElementById('tab-inventory').innerHTML = '<div class="panel p-8 text-center text-secondary">æ— åŒ¹é…SKU</div>'; return; }
    const invData = skus.map(sku => ({ ...sku, inv: calcInventoryMetrics(sku, INV_CONFIG) })).filter(x => x.du > 0 || x.ful > 0);
    invData.sort((a, b) => (a.inv.sellableDOS ?? 9999) - (b.inv.sellableDOS ?? 9999));
    
    const critical = invData.filter(x => x.inv.status === 'critical'), reorder = invData.filter(x => x.inv.status === 'reorder-now'), watch = invData.filter(x => x.inv.status === 'watch'), healthy = invData.filter(x => x.inv.status === 'healthy'), overstock = invData.filter(x => x.inv.overstockRisk);
    const hasReservedData = invData.some(x => x.inv.hasReservedData);
    
    document.getElementById('tab-inventory').innerHTML = `
    ${!hasReservedData ? `<div class="alert alert-warning mb-4"><span>âš ï¸ æœªå¯¼å…¥é¢„ç•™åº“å­˜ (reserved_qty)ï¼Œåˆ¤æ–­åä¹è§‚</span></div>` : ''}
    <div class="panel mb-4"><div class="panel-body"><div class="flex justify-between items-center flex-wrap gap-4"><span class="font-semibold">âš™ï¸ åº“å­˜é…ç½®</span><div class="flex gap-6 text-sm"><div><span class="text-tertiary">å¤´ç¨‹å‘¨æœŸ:</span> <span class="text-primary font-semibold">${INV_CONFIG.leadTimeDays}å¤©</span></div><div><span class="text-tertiary">å®‰å…¨åº“å­˜:</span> <span class="text-primary font-semibold">${INV_CONFIG.safetyDays}å¤©</span></div><div><span class="text-tertiary">ç›®æ ‡è¦†ç›–:</span> <span class="text-primary font-semibold">${INV_CONFIG.targetCoverDays}å¤©</span></div><div><span class="text-tertiary">ä½åº“å­˜é˜ˆå€¼:</span> <span class="negative font-semibold">&lt;${INV_CONFIG.lowStockThreshold}å¤©</span></div><div><span class="text-tertiary">ç§¯å‹é˜ˆå€¼:</span> <span style="color: var(--accent-info);" class="font-semibold">&gt;${INV_CONFIG.overStockThreshold}å¤©</span></div></div></div></div></div>
    <div class="grid md:grid-cols-5 gap-4">
        <div class="kpi-card" style="border-color: rgba(255,69,58,0.3);"><p class="kpi-label">ğŸ”´ æ–­è´§é£é™©</p><p class="kpi-value negative">${critical.length}</p><p class="kpi-sub">&lt;${INV_CONFIG.lowStockThreshold}å¤©</p></div>
        <div class="kpi-card" style="border-color: rgba(255,159,10,0.3);"><p class="kpi-label">ğŸŸ  éœ€è¡¥è´§</p><p class="kpi-value" style="color: var(--accent-warning);">${reorder.length}</p><p class="kpi-sub">&lt;${INV_CONFIG.leadTimeDays}å¤©</p></div>
        <div class="kpi-card" style="border-color: rgba(255,159,10,0.3);"><p class="kpi-label">ğŸŸ¡ å…³æ³¨</p><p class="kpi-value" style="color: var(--accent-warning);">${watch.length}</p><p class="kpi-sub">7-15å¤©</p></div>
        <div class="kpi-card" style="border-color: rgba(48,209,88,0.3);"><p class="kpi-label">ğŸŸ¢ å¥åº·</p><p class="kpi-value positive">${healthy.length}</p><p class="kpi-sub">â‰¥15å¤©</p></div>
        <div class="kpi-card" style="border-color: rgba(100,210,255,0.3);"><p class="kpi-label">ğŸ“¦ ç§¯å‹é£é™©</p><p class="kpi-value" style="color: var(--accent-info);">${overstock.length}</p><p class="kpi-sub">&gt;${INV_CONFIG.overStockThreshold}å¤©</p></div>
    </div>
    <div class="panel"><div class="panel-header"><span class="font-semibold">åº“å­˜æ˜ç»† <span class="text-secondary font-normal">(åŸºäº Sellable DOS åˆ¤æ–­)</span></span></div><div class="panel-body"><div class="overflow-auto" style="max-height: 400px;"><table class="data-table"><thead><tr><th>SKU</th><th>çŠ¶æ€</th><th class="text-right">å¯å”®</th><th class="text-right">åœ¨é€”</th><th class="text-right">æ—¥å‡</th><th class="text-right">Sellable DOS</th><th class="text-right">Total DOS</th><th class="text-right">Gap</th><th class="text-right">å»ºè®®è¡¥è´§</th></tr></thead><tbody>${invData.map(r => `<tr class="${r.inv.status === 'critical' ? '' : ''}"><td class="text-primary">${r.sku.substring(0, 18)}</td><td>${getInvStatusBadge(r.inv)}</td><td class="text-right ${r.ful < r.du * INV_CONFIG.lowStockThreshold ? 'negative' : ''}">${r.ful}</td><td class="text-right">${r.inb}</td><td class="text-right">${r.du.toFixed(1)}</td><td class="text-right ${r.inv.statusColor === 'danger' ? 'negative' : r.inv.statusColor === 'warning' ? '' : ''}" style="${r.inv.statusColor === 'warning' ? 'color: var(--accent-warning);' : ''}">${formatDOS(r.inv.sellableDOS)}</td><td class="text-right ${r.inv.overstockRisk ? '' : ''}" style="${r.inv.overstockRisk ? 'color: var(--accent-info);' : ''}">${formatDOS(r.inv.totalDOS)}</td><td class="text-right ${r.inv.stockoutGap > 0 ? 'negative' : 'text-tertiary'}">${r.inv.stockoutGap > 0 ? r.inv.stockoutGap.toFixed(0) + 'å¤©' : 'â€”'}</td><td class="text-right" style="color: var(--accent-primary);">${r.inv.orderQty > 0 ? r.inv.orderQty : 'â€”'}</td></tr>`).join('')}</tbody></table></div></div></div>
    <div class="panel" style="background: var(--bg-hover);"><div class="panel-body"><p class="font-semibold mb-3">ğŸ“‹ è¡¥è´§ç®—æ³•è¯´æ˜</p><div class="text-sm text-secondary space-y-1"><p><strong>Sellable DOS</strong> = å¯å”®åº“å­˜ / æ—¥å‡é”€é‡ (çŠ¶æ€åˆ¤æ–­ä¾æ®)</p><p><strong>Total DOS</strong> = (å¯å”®+åœ¨é€”-é¢„ç•™) / æ—¥å‡é”€é‡ (ç§¯å‹åˆ¤æ–­ä¾æ®)</p><p><strong>Stockout Gap</strong> = max(0, ${INV_CONFIG.leadTimeDays}å¤©å¤´ç¨‹ âˆ’ Sellable DOS)</p><p><strong>ROP</strong> = (${INV_CONFIG.leadTimeDays}+${INV_CONFIG.safetyDays}) Ã— æ—¥å‡ = ${INV_CONFIG.leadTimeDays + INV_CONFIG.safetyDays}å¤©ç”¨é‡</p><p><strong>å»ºè®®è¡¥è´§</strong> = max(0, ${INV_CONFIG.targetCoverDays}å¤©ç›®æ ‡ âˆ’ å¯ç”¨åº“å­˜)</p></div></div></div>`;
}

// ==================== é…ç½®æ¸²æŸ“ ====================
function renderConfig(skus, s) {
    document.getElementById('tab-config').innerHTML = `
    <div class="max-w-2xl mx-auto space-y-6">
        <div class="panel"><div class="panel-header"><span class="font-semibold">åº“å­˜é…ç½®</span></div><div class="panel-body space-y-3 text-sm">${[['Lead Time (å¤´ç¨‹)', INV_CONFIG.leadTimeDays + 'å¤© (' + (INV_CONFIG.leadTimeDays <= 15 ? 'å¿«èˆ¹' : INV_CONFIG.leadTimeDays <= 35 ? 'æ…¢èˆ¹' : 'ææ…¢èˆ¹') + ')'], ['Safety Days (å®‰å…¨)', INV_CONFIG.safetyDays + 'å¤©'], ['Target Cover (ç›®æ ‡)', INV_CONFIG.targetCoverDays + 'å¤©'], ['ä½åº“å­˜é˜ˆå€¼', '<' + INV_CONFIG.lowStockThreshold + 'å¤©'], ['ç§¯å‹é˜ˆå€¼', '>' + INV_CONFIG.overStockThreshold + 'å¤©']].map(([l, v]) => `<div class="flex justify-between py-2" style="border-bottom: 1px solid var(--border-subtle);"><span class="text-tertiary">${l}</span><span class="text-primary">${v}</span></div>`).join('')}</div></div>
        <div class="panel"><div class="panel-header"><span class="font-semibold">è®¡ç®—å£å¾„</span></div><div class="panel-body space-y-2 text-sm">${[['æ•°æ®å‘¨æœŸ', D.s.days + 'å¤©'], ['Run ID', runId], ['ç®—æ³•ç‰ˆæœ¬', ALGO_VERSION], ['å®šä»·æ¯›åˆ©', 'å‡€é”€å”®-ä½£é‡‘-FBA-æˆæœ¬-å¤´ç¨‹-é€€æ¬¾è´¹'], ['å¹¿å‘Šè´¡çŒ®åˆ©æ¶¦', 'å½’å› é”€å”®Ã—æ¯›åˆ©ç‡-å¹¿å‘ŠèŠ±è´¹']].map(([l, v]) => `<div class="flex justify-between py-2" style="border-bottom: 1px solid var(--border-subtle);"><span class="text-tertiary">${l}</span><span class="text-primary">${v}</span></div>`).join('')}</div></div>
    </div>`;
}

// ==================== å›¾è¡¨æ¸²æŸ“ ====================
function renderCharts(s, skus) {
    Object.values(charts).forEach(c => c && c.destroy && c.destroy());
    if (s.isEmpty) return;
    const textColor = getComputedStyle(document.body).getPropertyValue('--text-secondary');
    const gridColor = getComputedStyle(document.body).getPropertyValue('--border-subtle');
    const t10 = skus.slice(0, 10);
    const ctx1 = document.getElementById('chart1');
    if (ctx1) charts.c1 = new Chart(ctx1, { type: 'bar', data: { labels: t10.map(x => x.sku.substring(0, 12)), datasets: [{ data: t10.map(x => x.op), backgroundColor: t10.map(x => x.op >= 0 ? '#30d158' : '#ff453a') }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: gridColor }, ticks: { color: textColor } }, y: { grid: { display: false }, ticks: { color: textColor } } } } });
    const ctx2 = document.getElementById('chart2');
    if (ctx2) charts.c2 = new Chart(ctx2, { type: 'doughnut', data: { labels: ['ä½£é‡‘', 'FBA', 'æˆæœ¬', 'å¤´ç¨‹', 'æ¯›åˆ©'], datasets: [{ data: [s.ref, s.fba, s.cogs, s.frt, s.pp], backgroundColor: ['#ff453a', '#ff9f0a', '#ffd60a', '#bf5af2', '#30d158'] }] }, options: { plugins: { legend: { position: 'right', labels: { color: textColor } } } } });
    const ctx3 = document.getElementById('chart3');
    if (ctx3) { const wf = [{ n: 'å‡€é”€å”®', v: s.rev, c: '#30d158' }, { n: 'ä½£é‡‘', v: -s.ref, c: '#ff453a' }, { n: 'FBA', v: -s.fba, c: '#ff9f0a' }, { n: 'æˆæœ¬', v: -s.cogs, c: '#ffd60a' }, { n: 'å¤´ç¨‹', v: -s.frt, c: '#bf5af2' }, { n: 'å®šä»·æ¯›åˆ©', v: s.pp, c: '#34c759' }, { n: 'å¹¿å‘Š', v: -s.adSpend, c: '#af52de' }, { n: 'ç»è¥æ¯›åˆ©', v: s.op, c: s.op >= 0 ? '#0071e3' : '#ff453a' }]; charts.c3 = new Chart(ctx3, { type: 'bar', data: { labels: wf.map(d => d.n), datasets: [{ data: wf.map(d => d.v), backgroundColor: wf.map(d => d.c) }] }, options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: textColor } }, y: { grid: { color: gridColor }, ticks: { color: textColor } } } } }); }
}

// ==================== ä»»åŠ¡2: PDFå¯¼å‡ºï¼ˆå®Œæ•´ç‰ˆï¼‰ ====================
function exportPDF() { document.getElementById('pdf-tip-modal').classList.remove('hidden'); }

function closePdfTipAndPrint() {
    document.getElementById('pdf-tip-modal').classList.add('hidden');
    const { skus, summary: s } = applyFilters();
    const plan = generateAdOptimizationPlan(s, skus);
    const quadrants = { star: skus.filter(x => classifySkuQuadrant(x) === 'star'), question: skus.filter(x => classifySkuQuadrant(x) === 'question'), dog: skus.filter(x => classifySkuQuadrant(x) === 'dog'), eliminate: skus.filter(x => classifySkuQuadrant(x) === 'eliminate') };
    const invData = skus.map(sku => ({ ...sku, inv: calcInventoryMetrics(sku, INV_CONFIG) }));
    const critical = invData.filter(x => x.inv.status === 'critical');
    const timestamp = new Date().toLocaleString('zh-CN');
    
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>LGURT Dashboard Report</title><style>
        @page { size: A4; margin: 20mm; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; color: #1d1d1f; line-height: 1.5; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 16px; margin-top: 24px; margin-bottom: 12px; border-bottom: 2px solid #0071e3; padding-bottom: 4px; }
        h3 { font-size: 13px; margin-top: 16px; margin-bottom: 8px; }
        .meta { color: #6e6e73; font-size: 10px; margin-bottom: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .kpi { background: #f5f5f7; padding: 12px; border-radius: 8px; }
        .kpi-label { font-size: 10px; color: #6e6e73; text-transform: uppercase; }
        .kpi-value { font-size: 18px; font-weight: 600; }
        .positive { color: #34c759; }
        .negative { color: #ff3b30; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 10px; }
        th { background: #f5f5f7; padding: 8px; text-align: left; font-weight: 600; }
        td { padding: 8px; border-bottom: 1px solid #e5e5e5; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .alert-danger { background: #fff0f0; border-left: 3px solid #ff3b30; }
        .alert-warning { background: #fff8f0; border-left: 3px solid #ff9500; }
        .alert-success { background: #f0fff0; border-left: 3px solid #34c759; }
        .page-break { page-break-before: always; }
        .footer { position: fixed; bottom: 10mm; left: 0; right: 0; text-align: center; font-size: 9px; color: #6e6e73; }
    </style></head><body>
        <!-- å°é¢ -->
        <div style="text-align: center; padding-top: 100px;">
            <h1>ğŸ“Š LGURT Dashboard Report</h1>
            <p class="meta">ç”Ÿæˆæ—¶é—´: ${timestamp}</p>
            <div style="margin: 40px auto; max-width: 300px; text-align: left;">
                <p><strong>æ•°æ®å‘¨æœŸ:</strong> ${D.s.days} å¤©</p>
                <p><strong>ç­›é€‰èŒƒå›´:</strong> ${s.isFiltered ? s.skuCount + '/' + s.totalSkuCount + ' SKU' : 'å…¨é‡ ' + s.skuCount + ' SKU'}</p>
                <p><strong>ç®—æ³•ç‰ˆæœ¬:</strong> ${ALGO_VERSION}</p>
                <p><strong>Run ID:</strong> ${runId}</p>
                <p><strong>å¤´ç¨‹æ¨¡å¼:</strong> ${INV_CONFIG.leadTimeDays}å¤© (${INV_CONFIG.leadTimeDays <= 15 ? 'å¿«èˆ¹' : INV_CONFIG.leadTimeDays <= 35 ? 'æ…¢èˆ¹' : 'ææ…¢èˆ¹'})</p>
            </div>
        </div>
        
        <!-- Executive Summary -->
        <div class="page-break">
            <h2>Executive Summary</h2>
            <div class="kpi-grid">
                <div class="kpi"><div class="kpi-label">å‡€é”€å”®</div><div class="kpi-value">${$(s.rev)}</div></div>
                <div class="kpi"><div class="kpi-label">å®šä»·æ¯›åˆ©</div><div class="kpi-value">${$(s.pp)} (${pct(s.pm)})</div></div>
                <div class="kpi"><div class="kpi-label">å¹¿å‘ŠèŠ±è´¹</div><div class="kpi-value">${$(s.adSpend)} (${pct(s.ar)})</div></div>
                <div class="kpi"><div class="kpi-label">å‡€åˆ©æ¶¦</div><div class="kpi-value ${s.np >= 0 ? 'positive' : 'negative'}">${$(s.np)}</div></div>
            </div>
            <div class="alert ${s.np >= 0 ? 'alert-success' : 'alert-danger'}">
                <strong>ä¸€å¥è¯ç»“è®º:</strong> ${s.np >= 0 ? 'âœ… ç›ˆåˆ©çŠ¶æ€ï¼Œ' : 'âš ï¸ äºæŸçŠ¶æ€ï¼Œ'}å¹¿å‘Šå æ¯”${s.ar > s.pm ? 'è¶…å‡º' : 'ä½äº'}æ¯›åˆ©ç‡${s.ar > s.pm ? 'ï¼Œéœ€æ‰§è¡ŒPhase1ä¼˜åŒ–' : 'ï¼Œå¯é€‚å½“æ”¾é‡'}ã€‚
            </div>
            
            <h3>SKUå››è±¡é™åˆ†å¸ƒ</h3>
            <table>
                <tr><th>è±¡é™</th><th>æ•°é‡</th><th>è¯´æ˜</th></tr>
                <tr><td>ğŸŸ¢ æ˜æ˜Ÿ</td><td>${quadrants.star.length}</td><td>æ¯›åˆ©æ­£+å¹¿å‘Šè´¡çŒ®æ­£ï¼Œå¯æ”¾é‡</td></tr>
                <tr><td>ğŸŸ¡ é—®é¢˜</td><td>${quadrants.question.length}</td><td>æ¯›åˆ©è´Ÿä½†å¹¿å‘Šè´¡çŒ®æ­£ï¼Œéœ€è¯Šæ–­æˆæœ¬</td></tr>
                <tr><td>ğŸŸ  ç˜¦ç‹—</td><td>${quadrants.dog.length}</td><td>æ¯›åˆ©æ­£ä½†å¹¿å‘Šè´¡çŒ®è´Ÿï¼Œéœ€ä¼˜åŒ–å¹¿å‘Š</td></tr>
                <tr><td>ğŸ”´ æ·˜æ±°</td><td>${quadrants.eliminate.length}</td><td>åŒè´Ÿï¼Œè€ƒè™‘é€€å‡º</td></tr>
            </table>
        </div>
        
        <!-- Overview -->
        <div class="page-break">
            <h2>Overview - SKUå¥åº·åº¦</h2>
            <div class="kpi-grid">
                <div class="kpi"><div class="kpi-label">ç›ˆåˆ©SKU</div><div class="kpi-value positive">${skus.filter(x => x.op > 0).length}</div></div>
                <div class="kpi"><div class="kpi-label">äºæŸSKU</div><div class="kpi-value negative">${skus.filter(x => x.op < 0).length}</div></div>
                <div class="kpi"><div class="kpi-label">ä½åº“å­˜é£é™©</div><div class="kpi-value negative">${critical.length}</div></div>
                <div class="kpi"><div class="kpi-label">æ— é”€é‡</div><div class="kpi-value">${skus.filter(x => x.du <= 0).length}</div></div>
            </div>
            <h3>Top 10 ç»è¥åˆ©æ¶¦ SKU</h3>
            <table>
                <tr><th>SKU</th><th>é”€å”®é¢</th><th>æ¯›åˆ©ç‡</th><th>å¹¿å‘Šå æ¯”</th><th>ç»è¥åˆ©æ¶¦</th></tr>
                ${skus.slice(0, 10).map(r => `<tr><td>${r.sku}</td><td>${$(r.rev)}</td><td>${pct(r.pm)}</td><td>${pct(r.ar)}</td><td class="${r.op >= 0 ? 'positive' : 'negative'}">${$(r.op)}</td></tr>`).join('')}
            </table>
        </div>
        
        <!-- Profit -->
        <div class="page-break">
            <h2>Profit Analysis - åˆ©æ¶¦åˆ†æ</h2>
            <h3>ç›ˆåˆ© SKU Top 10</h3>
            <table>
                <tr><th>SKU</th><th>é”€å”®é¢</th><th>æ¯›åˆ©ç‡</th><th>ç»è¥åˆ©æ¶¦</th></tr>
                ${skus.filter(x => x.op > 0).sort((a, b) => b.op - a.op).slice(0, 10).map(r => `<tr><td>${r.sku}</td><td>${$(r.rev)}</td><td>${pct(r.pm)}</td><td class="positive">${$(r.op)}</td></tr>`).join('')}
            </table>
            <h3>äºæŸ SKU Top 10</h3>
            <table>
                <tr><th>SKU</th><th>é”€å”®é¢</th><th>æ¯›åˆ©ç‡</th><th>ç»è¥åˆ©æ¶¦</th></tr>
                ${skus.filter(x => x.op < 0).sort((a, b) => a.op - b.op).slice(0, 10).map(r => `<tr><td>${r.sku}</td><td>${$(r.rev)}</td><td class="${r.pm < 0 ? 'negative' : ''}">${pct(r.pm)}</td><td class="negative">${$(r.op)}</td></tr>`).join('')}
            </table>
        </div>
        
        <!-- Decision - è¯Šæ–­å»ºè®® -->
        <div class="page-break">
            <h2>Decision Center - è¯Šæ–­å»ºè®®</h2>
            <h3>éœ€å…³æ³¨çš„SKU (é—®é¢˜æ•°>0æˆ–è§¦å‘æ­¢æŸ)</h3>
            <table>
                <tr><th>SKU</th><th>è±¡é™</th><th>è§’è‰²</th><th>æ¯›åˆ©ç‡</th><th>å¹¿å‘Šè´¡çŒ®</th><th>é—®é¢˜æ•°</th><th>é¦–è¦å»ºè®®</th></tr>
                ${skus.map(sku => generateSkuDiagnosis(sku)).filter(d => !d.isHealthy || d.issues.length > 0).slice(0, 20).map(d => {
                    const sku = skus.find(x => x.sku === d.sku);
                    return `<tr><td>${d.sku.substring(0, 15)}</td><td>${d.qInfo.icon} ${d.qInfo.name}</td><td>${d.roleConfig.name}</td><td class="${sku.pm < 0 ? 'negative' : ''}">${pct(sku.pm)}</td><td class="${d.adContrib >= 0 ? 'positive' : 'negative'}">$${d.adContrib.toFixed(0)}</td><td>${d.issues.length}</td><td>${d.actions[0]?.text.substring(0, 30) || '-'}...</td></tr>`;
                }).join('')}
            </table>
            ${skus.map(sku => generateSkuDiagnosis(sku)).filter(d => d.stopLoss.length > 0).length > 0 ? `
            <h3>æ­¢æŸè­¦å‘Š</h3>
            <div class="alert alert-danger">
                ${skus.map(sku => generateSkuDiagnosis(sku)).filter(d => d.stopLoss.length > 0).slice(0, 5).map(d => `<p><strong>${d.sku}:</strong> ${d.stopLoss[0]}</p>`).join('')}
            </div>
            ` : ''}
        </div>
        
        <!-- Ads -->
        <div class="page-break">
            <h2>Ads Management - å¹¿å‘Šç®¡ç†</h2>
            <div class="kpi-grid">
                <div class="kpi"><div class="kpi-label">å½“å‰å¹¿å‘Šå æ¯”</div><div class="kpi-value">${pct(plan.currentAdRatio)}</div></div>
                <div class="kpi"><div class="kpi-label">ç›ˆäºçº¿</div><div class="kpi-value">${pct(plan.breakEvenAdRatio)}</div></div>
                <div class="kpi"><div class="kpi-label">ç›®æ ‡</div><div class="kpi-value positive">${pct(plan.targetAdRatio)}</div></div>
                <div class="kpi"><div class="kpi-label">å¹¿å‘Šä¾èµ–åº¦</div><div class="kpi-value">${pct(plan.adDependency)}</div></div>
            </div>
            
            <h3>Phase 1: æ— æ„ä¹‰æ¶ˆè€—æ¸…å•</h3>
            ${plan.phase1.wasteList.length > 0 ? `
            <table>
                <tr><th>SKU</th><th>æµªè´¹é‡‘é¢</th><th>åŸå› </th><th>å»ºè®®åŠ¨ä½œ</th></tr>
                ${plan.phase1.wasteList.slice(0, 15).map(w => `<tr><td>${w.sku}</td><td class="negative">$${w.wasted_spend.toFixed(0)}</td><td>${w.reason}</td><td>${w.action_desc}</td></tr>`).join('')}
            </table>
            <div class="alert alert-success">Phase1é¢„è®¡èŠ‚çœ: ${$(plan.phase1.totalSavings)}ï¼Œå¹¿å‘Šå æ¯”ä¸‹é™ ${pct(plan.phase1.ratioReduction)}</div>
            ` : '<p>æœªå‘ç°æ˜æ˜¾æ— æ„ä¹‰æ¶ˆè€—</p>'}
            
            ${plan.phase2.plan.length > 0 ? `
            <h3>Phase 2: å¢é‡ä¼˜åŒ–å‘¨è®¡åˆ’</h3>
            <table>
                <tr><th>å‘¨æ¬¡</th><th>ç›®æ ‡å æ¯”</th><th>é™å¹…</th><th>æ—¥é¢„ç®—</th><th>æ‰§è¡ŒåŠ¨ä½œ</th></tr>
                ${plan.phase2.plan.map(p => `<tr><td>Week ${p.week}</td><td>${pct(p.target_ad_ratio)}</td><td>-${pct(p.delta)}</td><td>${$(p.daily_budget)}</td><td>${p.actions.join(', ')}</td></tr>`).join('')}
            </table>` : ''}
            
            <h3>é”€é‡å½±å“åº¦ä¼°ç®—</h3>
            <table>
                <tr><th>ä¼°è®¡ç±»å‹</th><th>æ¯é™1%å½±å“</th><th>æ€»é™å¹…å½±å“</th><th>åœºæ™¯è¯´æ˜</th></tr>
                <tr><td>ä¿å®ˆ</td><td>${pct(plan.impact.perPointPct.conservative.rate)}</td><td>${plan.impact.totalPct.conservative}%</td><td>${plan.impact.perPointPct.conservative.desc}</td></tr>
                <tr><td>ä¸­æ€§</td><td>${pct(plan.impact.perPointPct.moderate.rate)}</td><td>${plan.impact.totalPct.moderate}%</td><td>${plan.impact.perPointPct.moderate.desc}</td></tr>
                <tr><td>æ¿€è¿›</td><td>${pct(plan.impact.perPointPct.aggressive.rate)}</td><td>${plan.impact.totalPct.aggressive}%</td><td>${plan.impact.perPointPct.aggressive.desc}</td></tr>
            </table>
            ${plan.hasNonlinearRisk ? `<div class="alert alert-warning">âš ï¸ ${plan.riskWarning}</div>` : ''}
        </div>
        
        <!-- Inventory -->
        <div class="page-break">
            <h2>Inventory Management - åº“å­˜ç®¡ç†</h2>
            <div class="kpi-grid">
                <div class="kpi"><div class="kpi-label">ğŸ”´ æ–­è´§é£é™©</div><div class="kpi-value negative">${invData.filter(x => x.inv.status === 'critical').length}</div></div>
                <div class="kpi"><div class="kpi-label">ğŸŸ  éœ€è¡¥è´§</div><div class="kpi-value">${invData.filter(x => x.inv.status === 'reorder-now').length}</div></div>
                <div class="kpi"><div class="kpi-label">ğŸŸ¢ å¥åº·</div><div class="kpi-value positive">${invData.filter(x => x.inv.status === 'healthy').length}</div></div>
                <div class="kpi"><div class="kpi-label">ğŸ“¦ ç§¯å‹é£é™©</div><div class="kpi-value">${invData.filter(x => x.inv.overstockRisk).length}</div></div>
            </div>
            
            ${critical.length > 0 ? `
            <h3>ä½åº“å­˜é£é™© SKU (Sellable DOS < ${INV_CONFIG.lowStockThreshold}å¤©)</h3>
            <table>
                <tr><th>SKU</th><th>å¯å”®</th><th>åœ¨é€”</th><th>æ—¥å‡</th><th>Sellable DOS</th><th>å»ºè®®è¡¥è´§</th></tr>
                ${critical.slice(0, 20).map(r => `<tr><td>${r.sku}</td><td>${r.ful}</td><td>${r.inb}</td><td>${r.du.toFixed(1)}</td><td class="negative">${r.inv.sellableDOS?.toFixed(1) || 0}å¤©</td><td>${r.inv.orderQty}</td></tr>`).join('')}
            </table>` : '<div class="alert alert-success">âœ… æ— ä½åº“å­˜é£é™©SKU</div>'}
        </div>
        
        <!-- Config -->
        <div class="page-break">
            <h2>Config & Definitions - é…ç½®ä¸å®šä¹‰</h2>
            <h3>åº“å­˜é…ç½®</h3>
            <table>
                <tr><th>å‚æ•°</th><th>å€¼</th><th>è¯´æ˜</th></tr>
                <tr><td>lead_time_days</td><td>${INV_CONFIG.leadTimeDays}</td><td>å¤´ç¨‹å‘¨æœŸ (${INV_CONFIG.leadTimeDays <= 15 ? 'å¿«èˆ¹' : INV_CONFIG.leadTimeDays <= 35 ? 'æ…¢èˆ¹' : 'ææ…¢èˆ¹'})</td></tr>
                <tr><td>safety_days</td><td>${INV_CONFIG.safetyDays}</td><td>å®‰å…¨åº“å­˜å¤©æ•°</td></tr>
                <tr><td>target_cover_days</td><td>${INV_CONFIG.targetCoverDays}</td><td>ç›®æ ‡è¦†ç›–å¤©æ•°</td></tr>
                <tr><td>low_stock_threshold</td><td>${INV_CONFIG.lowStockThreshold}</td><td>ä½åº“å­˜é˜ˆå€¼(å¤©)</td></tr>
                <tr><td>overstock_threshold</td><td>${INV_CONFIG.overStockThreshold}</td><td>ç§¯å‹é˜ˆå€¼(å¤©)</td></tr>
            </table>
            <h3>å­—æ®µå®šä¹‰</h3>
            <table>
                <tr><th>å­—æ®µ</th><th>å…¬å¼</th></tr>
                <tr><td>å®šä»·æ¯›åˆ©</td><td>å‡€é”€å”® - ä½£é‡‘ - FBA - æˆæœ¬ - å¤´ç¨‹ - é€€æ¬¾è´¹</td></tr>
                <tr><td>ç»è¥æ¯›åˆ©</td><td>å®šä»·æ¯›åˆ© - å¹¿å‘ŠèŠ±è´¹</td></tr>
                <tr><td>å‡€åˆ©æ¶¦</td><td>ç»è¥æ¯›åˆ© - å›ºå®šæˆæœ¬</td></tr>
                <tr><td>å¹¿å‘Šè´¡çŒ®åˆ©æ¶¦</td><td>å½’å› é”€å”® Ã— æ¯›åˆ©ç‡ - å¹¿å‘ŠèŠ±è´¹</td></tr>
                <tr><td>Sellable DOS</td><td>å¯å”®åº“å­˜ / æ—¥å‡é”€é‡</td></tr>
                <tr><td>Total DOS</td><td>(å¯å”® + åœ¨é€” - é¢„ç•™) / æ—¥å‡é”€é‡</td></tr>
            </table>
        </div>
        
        <div class="footer">Run ID: ${runId} | Generated: ${timestamp} | Algorithm: ${ALGO_VERSION}</div>
    </body></html>`;
    
    const frame = document.getElementById('print-frame');
    frame.contentDocument.open();
    frame.contentDocument.write(html);
    frame.contentDocument.close();
    setTimeout(() => frame.contentWindow.print(), 500);
}

// ==================== ä»»åŠ¡3: Excelå¯¼å‡ºï¼ˆSingle Source of Truthï¼‰ ====================
function exportXLSX() {
    const { skus, summary: s } = applyFilters();
    const plan = generateAdOptimizationPlan(s, skus);
    const timestamp = new Date().toLocaleString('zh-CN');
    const wb = XLSX.utils.book_new();
    const bundle = buildResultBundle(s, skus, plan);
    
    // ä¸€è‡´æ€§æ ¡éªŒ
    if (!bundle.checksums.isConsistent) {
        console.warn('ä¸€è‡´æ€§æ ¡éªŒè­¦å‘Š: SKUæ±‡æ€»ä¸Summaryä¸ä¸€è‡´', bundle.checksums);
    }
    
    // Sheet 1: Summary_Store
    const summaryData = [['LGURT Dashboard v5.2 - åº—é“ºæ±‡æ€»'], [''], ['å…ƒæ•°æ®'], ['ç”Ÿæˆæ—¶é—´', timestamp], ['Run ID', runId], ['ç®—æ³•ç‰ˆæœ¬', ALGO_VERSION], ['æ•°æ®å‘¨æœŸ', s.days + 'å¤©'], ['SKUæ•°é‡', skus.length], ['å¤´ç¨‹æ¨¡å¼', INV_CONFIG.leadTimeDays + 'å¤©'], [''], ['å…³é”®æŒ‡æ ‡', 'å€¼', 'å æ¯”'], ['å‡€é”€å”®é¢', s.rev, '100%'], ['å®šä»·æ¯›åˆ©', s.pp, pctVal(s.pm)], ['å¹¿å‘ŠèŠ±è´¹', s.adSpend, pctVal(s.ar)], ['ç»è¥æ¯›åˆ©', s.op, pctVal(s.om)], ['å›ºå®šæˆæœ¬', s.mfPeriod, ''], ['å‡€åˆ©æ¶¦', s.np, pctVal(s.npm)], [''], ['å¹¿å‘Šåˆ†æ'], ['å¹¿å‘Šä¾èµ–åº¦', pctVal(plan.adDependency)], ['ç›ˆäºçº¿å¹¿å‘Šå æ¯”', pctVal(plan.breakEvenAdRatio)], ['ç›®æ ‡å¹¿å‘Šå æ¯”', pctVal(plan.targetAdRatio)], ['Phase1èŠ‚æµé¢„ä¼°', plan.phase1.totalSavings], ['Phase2éœ€é™å¹…åº¦', pctVal(plan.phase2.gap)]];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary_Store');
    
    // Sheet 2: SKU_Full (å«è¯Šæ–­)
    const skuFullData = [['SKU', 'ASIN', 'å“ç±»', 'é”€å”®é¢', 'é”€é‡', 'æ—¥å‡', 'ä½£é‡‘', 'FBA', 'æˆæœ¬', 'å¤´ç¨‹', 'é€€æ¬¾è´¹', 'å®šä»·æ¯›åˆ©', 'æ¯›åˆ©ç‡', 'å¹¿å‘ŠèŠ±è´¹', 'å½’å› é”€å”®', 'å¹¿å‘Šå æ¯”', 'ACOS', 'ROAS', 'å¹¿å‘Šè´¡çŒ®', 'ç»è¥åˆ©æ¶¦', 'ç»è¥æ¯›åˆ©ç‡', 'å››è±¡é™', 'SKUè§’è‰²', 'Sellable DOS', 'Total DOS', 'åº“å­˜çŠ¶æ€', 'å»ºè®®è¡¥è´§', 'é—®é¢˜æ•°', 'é¦–è¦å»ºè®®', 'å¹¿å‘ŠåŠ¨ä½œ']];
    skus.forEach(r => { 
        const q = classifySkuQuadrant(r); 
        const qInfo = getQuadrantInfo(q); 
        const role = getSkuRole(r.sku); 
        const d = generateSkuDiagnosis(r); 
        const inv = calcInventoryMetrics(r); 
        const adSug = generateSkuAdSuggestion(r);
        skuFullData.push([r.sku, r.asin, r.cat, r.rev, r.units, r.du, r.ref, r.fba, r.cogs, r.frt, r.rfmFee, r.pp, r.pm, r.adSpend, r.adSales, r.ar, r.acos, r.roas, d.adContrib, r.op, r.om, qInfo.name, SKU_ROLE_CONFIG[role].name, inv.sellableDOS, inv.totalDOS, inv.status, inv.orderQty, d.issues.length, d.actions[0]?.text || '-', adSug.primary_action?.action_desc || '-']); 
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(skuFullData), 'SKU_Full');
    
    // Sheet 3: Ads_Detail (å«Phase1/Phase2 + SKUçº§å¹¿å‘Šå»ºè®®)
    const adsData = [['=== Phase 1 æ— æ„ä¹‰æ¶ˆè€—æ¸…å• ==='], ['SKU', 'ASIN', 'æµªè´¹é‡‘é¢', 'åŸå› ', 'å»ºè®®åŠ¨ä½œ', 'åŠ¨ä½œæè¿°']];
    plan.phase1.wasteList.forEach(w => adsData.push([w.sku, w.asin, w.wasted_spend, w.reason, w.suggested_action, w.action_desc]));
    adsData.push([''], ['Phase1æ±‡æ€»'], ['æ€»èŠ‚çœ', plan.phase1.totalSavings], ['å æ¯”ä¸‹é™', pctVal(plan.phase1.ratioReduction)], ['æ‰§è¡Œåå¹¿å‘Šå æ¯”', pctVal(plan.phase1.afterRatio)], ['é”€é‡å½±å“å‡è®¾', plan.phase1.salesImpactAssumption]);
    adsData.push([''], ['=== Phase 2 å‘¨è®¡åˆ’ ==='], ['å‘¨æ¬¡', 'ç›®æ ‡å æ¯”', 'é™å¹…', 'æ—¥é¢„ç®—', 'åŠ¨ä½œ1', 'åŠ¨ä½œ2', 'æ£€æŸ¥ç‚¹']);
    plan.phase2.plan.forEach(p => adsData.push(['Week ' + p.week, p.target_ad_ratio, p.delta, p.daily_budget, p.actions[0] || '', p.actions[1] || '', p.checkpoint || '']));
    adsData.push([''], ['=== é”€é‡å½±å“åº¦ ==='], ['ç±»å‹', 'æ¯é™1%å½±å“', 'æ€»å½±å“', 'è¯´æ˜'], ['ä¿å®ˆ', plan.impact.perPointPct.conservative.rate, plan.impact.totalPct.conservative + '%', plan.impact.perPointPct.conservative.desc], ['ä¸­æ€§', plan.impact.perPointPct.moderate.rate, plan.impact.totalPct.moderate + '%', plan.impact.perPointPct.moderate.desc], ['æ¿€è¿›', plan.impact.perPointPct.aggressive.rate, plan.impact.totalPct.aggressive + '%', plan.impact.perPointPct.aggressive.desc]);
    if (plan.riskWarning) adsData.push([''], ['é£é™©è­¦å‘Š', plan.riskWarning]);
    
    // SKUçº§å¹¿å‘Šå»ºè®®
    adsData.push([''], ['=== SKUçº§å¹¿å‘Šå»ºè®® ==='], ['SKU', 'ASIN', 'å½“å‰èŠ±è´¹', 'ACOS', 'å¹¿å‘Šå æ¯”', 'åŠ¨ä½œç±»å‹', 'åŠ¨ä½œæè¿°', 'é¢„è®¡èŠ‚çœ', 'é”€é‡å½±å“', 'å­åŠ¨ä½œ1', 'å­åŠ¨ä½œ2', 'å­åŠ¨ä½œ3']);
    const adSuggestions = bundle.ads.skuSuggestions;
    adSuggestions.filter(x => x.primary_action).forEach(x => {
        const pa = x.primary_action;
        adsData.push([x.sku, x.asin, x.current_spend, x.current_acos, x.current_ar, pa.action_type, pa.action_desc, pa.expected_save, pa.sales_impact, pa.sub_actions?.[0] || '', pa.sub_actions?.[1] || '', pa.sub_actions?.[2] || '']);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(adsData), 'Ads_Detail');
    
    // Sheet 4: Inventory_Detail
    const invData = [['SKU', 'ASIN', 'å¯å”®', 'åœ¨é€”', 'é¢„ç•™', 'å¯ç”¨', 'æ—¥å‡', 'Sellable DOS', 'Total DOS', 'Stockout Gap', 'çŠ¶æ€', 'ç§¯å‹é£é™©', 'ROP', 'ç›®æ ‡åº“å­˜', 'å»ºè®®è¡¥è´§', 'å¤‡æ³¨']];
    skus.forEach(r => { const m = calcInventoryMetrics(r, INV_CONFIG); const statusText = { 'critical': 'æ–­è´§é£é™©', 'reorder-now': 'éœ€è¡¥è´§', 'watch': 'å…³æ³¨', 'healthy': 'å¥åº·', 'no-sales': 'æ— é”€é‡' }[m.status]; invData.push([r.sku, r.asin, r.ful, r.inb, r.rsv || 0, m.availableUnits, r.du, m.sellableDOS, m.totalDOS, m.stockoutGap, statusText, m.overstockRisk ? 'æ˜¯' : 'å¦', m.ropUnits, m.targetUnits, m.orderQty, m.hasReservedData ? '' : 'ç¼ºå°‘é¢„ç•™']); });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(invData), 'Inventory_Detail');
    
    // Sheet 5: Config_And_Definitions
    const configData = [['LGURT Dashboard é…ç½®ä¸å®šä¹‰'], [''], ['=== å…ƒæ•°æ® ==='], ['ç”Ÿæˆæ—¶é—´', timestamp], ['Run ID', runId], ['ç®—æ³•ç‰ˆæœ¬', ALGO_VERSION], ['æ•°æ®å‘¨æœŸ', s.days + 'å¤©'], ['SKUæ€»æ•°', skus.length], [''], ['=== åº“å­˜é…ç½® ==='], ['å‚æ•°', 'å€¼', 'è¯´æ˜'], ['lead_time_days', INV_CONFIG.leadTimeDays, 'å¤´ç¨‹å‘¨æœŸ(' + (INV_CONFIG.leadTimeDays <= 15 ? 'å¿«èˆ¹' : INV_CONFIG.leadTimeDays <= 35 ? 'æ…¢èˆ¹' : 'ææ…¢èˆ¹') + ')'], ['safety_days', INV_CONFIG.safetyDays, 'å®‰å…¨åº“å­˜'], ['target_cover_days', INV_CONFIG.targetCoverDays, 'ç›®æ ‡è¦†ç›–'], ['low_stock_threshold', INV_CONFIG.lowStockThreshold, 'ä½åº“å­˜é˜ˆå€¼'], ['overstock_threshold', INV_CONFIG.overStockThreshold, 'ç§¯å‹é˜ˆå€¼'], [''], ['=== å­—æ®µå®šä¹‰ ==='], ['å­—æ®µ', 'å…¬å¼/è¯´æ˜'], ['å®šä»·æ¯›åˆ©', 'å‡€é”€å”® - ä½£é‡‘ - FBA - å•†å“æˆæœ¬ - å¤´ç¨‹ - é€€æ¬¾ç®¡ç†è´¹'], ['ç»è¥æ¯›åˆ©', 'å®šä»·æ¯›åˆ© - å¹¿å‘ŠèŠ±è´¹'], ['å‡€åˆ©æ¶¦', 'ç»è¥æ¯›åˆ© - å›ºå®šæˆæœ¬(æŒ‰å‘¨æœŸåˆ†æ‘Š)'], ['å¹¿å‘Šè´¡çŒ®åˆ©æ¶¦', 'å½’å› é”€å”® Ã— æ¯›åˆ©ç‡ - å¹¿å‘ŠèŠ±è´¹'], ['Sellable DOS', 'å¯å”®åº“å­˜ / æ—¥å‡é”€é‡ (çŠ¶æ€åˆ¤æ–­ä¾æ®)'], ['Total DOS', '(å¯å”®+åœ¨é€”-é¢„ç•™) / æ—¥å‡é”€é‡ (ç§¯å‹åˆ¤æ–­ä¾æ®)'], ['Stockout Gap', 'max(0, å¤´ç¨‹å¤©æ•° - Sellable DOS)'], ['ROP', '(å¤´ç¨‹+å®‰å…¨) Ã— æ—¥å‡é”€é‡'], ['å»ºè®®è¡¥è´§', 'max(0, ç›®æ ‡åº“å­˜ - å¯ç”¨åº“å­˜)'], [''], ['=== ä¸€è‡´æ€§æ ¡éªŒ ==='], ['SKUæ±‡æ€»é”€å”®', bundle.checksums.totalRev], ['Summaryé”€å”®', bundle.checksums.summaryRev], ['å·®å¼‚', Math.abs(bundle.checksums.totalRev - bundle.checksums.summaryRev)], ['æ ¡éªŒç»“æœ', bundle.checksums.isConsistent ? 'âœ“ é€šè¿‡' : 'âš  ä¸ä¸€è‡´']];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(configData), 'Config_And_Definitions');
    
    XLSX.writeFile(wb, `LGURT_v5.2_${runId}_${s.days}å¤©.xlsx`);
}

function exportCSV() { const { skus } = applyFilters(); const headers = ['SKU', 'é”€å”®é¢', 'æ¯›åˆ©ç‡', 'å¹¿å‘Šå æ¯”', 'ç»è¥åˆ©æ¶¦', 'Sellable DOS', 'åº“å­˜çŠ¶æ€']; const rows = skus.map(r => { const m = calcInventoryMetrics(r); return [r.sku, r.rev, r.pm, r.ar, r.op, m.sellableDOS, m.status].join(','); }); const blob = new Blob(['\ufeff' + [headers.join(','), ...rows].join('\n')], { type: 'text/csv;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `LGURT_${runId}.csv`; a.click(); }

function pctVal(v) { return (v * 100).toFixed(1) + '%'; }

// ==================== æ•°æ®å¤„ç† ====================
function processWorkbook(wb) {
    const days = parseInt(document.getElementById('days-input').value) || 31;
    const sales = parseSheet(wb, 'sales_data', 19), master = parseSheet(wb, 'sku_master', 18), ads = parseSheet(wb, 'ad_data', 18), inv = parseSheet(wb, 'inventory_data', 15), fc = parseSheet(wb, 'fixed_costs', 12);
    const skuInfo = {}; master.forEach(r => { if (r[0]) skuInfo[r[0]] = { name: r[2] || r[0], cat: r[3] || 'æœªåˆ†ç±»', cost: num(r[4]), freight: num(r[5]) }; });
    const adBySku = {}, adByAsin = {}; ads.forEach(r => { const asin = String(r[1] || ''), sku = String(r[2] || '').trim(); const ad = { spend: num(r[10]), imp: num(r[7]), clk: num(r[8]), sales: num(r[4]) }; if (sku) { if (!adBySku[sku]) adBySku[sku] = { spend: 0, imp: 0, clk: 0, sales: 0 }; adBySku[sku].spend += ad.spend; adBySku[sku].imp += ad.imp; adBySku[sku].clk += ad.clk; adBySku[sku].sales += ad.sales; } else if (asin) { const k = asin.split('-')[0]; if (!adByAsin[k]) adByAsin[k] = { spend: 0, imp: 0, clk: 0, sales: 0 }; adByAsin[k].spend += ad.spend; adByAsin[k].imp += ad.imp; adByAsin[k].clk += ad.clk; adByAsin[k].sales += ad.sales; } });
    const invBySku = {}; inv.forEach(r => { if (r[1]) invBySku[r[1]] = { ful: num(r[5]), inb: num(r[6]), rsv: num(r[7]) }; });
    let mfM = 0, fcd = { labor: 0, rent: 0, sw: 0 }; if (fc.length) { const l = fc[fc.length - 1]; fcd = { labor: num(l[1]), rent: num(l[2]), sw: num(l[3]) }; mfM = fcd.labor + fcd.rent + fcd.sw + num(l[4]) + num(l[5]); }
    const mfD = mfM / 30, mfP = mfD * days;
    const skus = []; sales.forEach(r => { const sku = r[2], asin = r[1]; if (!sku || num(r[6]) <= 0) return; const info = skuInfo[sku] || { name: sku, cat: 'æœªåˆ†ç±»', cost: 0, freight: 0 }; const units = num(r[5]), rev = num(r[6]), rfm = Math.abs(num(r[8])), ref = num(r[9]), fba = num(r[10]); const cogs = (info.cost || 0) * units, frt = (info.freight || 0) * units; const pp = rev - ref - fba - cogs - frt - rfm, pm = rev > 0 ? pp / rev : 0; let ad = adBySku[sku]; if (!ad) { const k = String(asin).split('-')[0]; ad = adByAsin[k] || { spend: 0, imp: 0, clk: 0, sales: 0 }; } const op = pp - ad.spend, om = rev > 0 ? op / rev : 0, ar = rev > 0 ? ad.spend / rev : 0; const iv = invBySku[sku] || { ful: 0, inb: 0, rsv: 0 }; const du = units / days; skus.push({ sku, asin, name: info.name || sku, cat: info.cat, units, du: rd(du, 1), rev: rd(rev, 2), ref: rd(ref, 2), fba: rd(fba, 2), cogs: rd(cogs, 2), frt: rd(frt, 2), rfmFee: rd(rfm, 2), pp: rd(pp, 2), pm: rd(pm, 4), adSpend: rd(ad.spend, 2), adImp: ad.imp, adClk: ad.clk, adSales: rd(ad.sales, 2), op: rd(op, 2), om: rd(om, 4), ar: rd(ar, 4), acos: ad.sales > 0 ? rd(ad.spend / ad.sales, 4) : 0, roas: ad.spend > 0 ? rd(ad.sales / ad.spend, 2) : 0, ful: iv.ful, inb: iv.inb, rsv: iv.rsv }); });
    skus.sort((a, b) => b.op - a.op);
    const t = skus.reduce((a, s) => ({ rev: a.rev + s.rev, units: a.units + s.units, ref: a.ref + s.ref, fba: a.fba + s.fba, cogs: a.cogs + s.cogs, frt: a.frt + s.frt, rfmFee: a.rfmFee + s.rfmFee, pp: a.pp + s.pp, adSpend: a.adSpend + s.adSpend, op: a.op + s.op, imp: a.imp + s.adImp, clk: a.clk + s.adClk, adSales: a.adSales + s.adSales }), { rev: 0, units: 0, ref: 0, fba: 0, cogs: 0, frt: 0, rfmFee: 0, pp: 0, adSpend: 0, op: 0, imp: 0, clk: 0, adSales: 0 });
    const dRev = t.rev / days, om = t.rev > 0 ? t.op / t.rev : 0, np = t.op - mfP, be = om > 0 ? mfD / om : 0;
    return { s: { ...t, days, dRev: rd(dRev, 2), pm: t.rev > 0 ? t.pp / t.rev : 0, ar: t.rev > 0 ? t.adSpend / t.rev : 0, om, mfMonthly: mfM, mfDaily: rd(mfD, 2), mfPeriod: rd(mfP, 2), np: rd(np, 2), npm: t.rev > 0 ? np / t.rev : 0, ctr: t.imp > 0 ? t.clk / t.imp : 0, cpc: t.clk > 0 ? t.adSpend / t.clk : 0, acos: t.adSales > 0 ? t.adSpend / t.adSales : 0, roas: t.adSpend > 0 ? t.adSales / t.adSpend : 0, dailyBreakEven: rd(be, 2) }, skus, fc: fcd };
}

function parseSheet(wb, n, skip) { if (!wb.SheetNames.includes(n)) return []; return XLSX.utils.sheet_to_json(wb.Sheets[n], { header: 1, defval: '' }).slice(skip); }
function num(v) { const n = parseFloat(v); return isNaN(n) ? 0 : n; }
function rd(v, d) { return Math.round(v * Math.pow(10, d)) / Math.pow(10, d); }
function pct(v) { return (v * 100).toFixed(1) + '%'; }
function $(v) { return '$' + v.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active')); document.getElementById('tab-' + id).classList.remove('hidden'); document.getElementById('tab-' + id).classList.add('animate-in'); document.querySelector(`[data-tab="${id}"]`).classList.add('active'); }
function resetDashboard() { document.getElementById('upload-section').classList.remove('hidden'); document.getElementById('dashboard-section').classList.add('hidden'); fi.value = ''; D = null; allSkus = []; Object.values(charts).forEach(c => c && c.destroy); charts = {}; loadHistory(); }
</script>
</body>
</html>
